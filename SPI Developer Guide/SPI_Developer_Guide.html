<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.17">
<title>SPI Developer Guide</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/*! Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment the following line when using as a custom stylesheet */
/* @import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700"; */
html{font-family:sans-serif;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
b,strong{font-weight:bold}
abbr{font-size:.9em}
abbr[title]{cursor:help;border-bottom:1px dotted #dddddf;text-decoration:none}
dfn{font-style:italic}
hr{height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type=button],input[type=reset],input[type=submit]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type=checkbox],input[type=radio]{padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,::before,::after{box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;line-height:1;position:relative;cursor:auto;-moz-tab-size:4;-o-tab-size:4;tab-size:4;word-wrap:anywhere;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:1px solid #dedede;word-wrap:normal}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre).nobreak{word-wrap:normal}
:not(pre).nowrap{white-space:nowrap}
:not(pre).pre-wrap{white-space:pre-wrap}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;border-radius:3px;box-shadow:0 1px 0 rgba(0,0,0,.2),inset 0 0 0 .1em #fff;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin:0 auto;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:flex;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border:1px solid #e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:none;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:hsla(0,0%,100%,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details{margin-left:1.25rem}
details>summary{cursor:pointer;display:block;position:relative;line-height:1.6;margin-bottom:.625rem;outline:none;-webkit-tap-highlight-color:transparent}
details>summary::-webkit-details-marker{display:none}
details>summary::before{content:"";border:solid transparent;border-left:solid;border-width:.3em 0 .3em .5em;position:absolute;top:.5em;left:-1.25rem;transform:translateX(15%)}
details[open]>summary::before{border:solid transparent;border-top:solid;border-width:.5em .3em 0;transform:translateY(15%)}
details>summary::after{content:"";width:1.25rem;height:1em;position:absolute;top:.3em;left:-1.25rem}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class=paragraph]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6);word-wrap:anywhere}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border:1px solid #e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border:1px solid #dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{border-radius:4px;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class=highlight],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos,pre.pygments .linenos{border-right:1px solid;opacity:.35;padding-right:.5em;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}
pre.pygments span.linenos{display:inline-block;margin-right:.75em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans-serif;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;font-size:.85rem;text-align:left;margin-right:0}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content{margin-bottom:1.25em;word-wrap:anywhere}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>*>tr>*{border-width:1px}
table.grid-cols>*>tr>*{border-width:0 1px}
table.grid-rows>*>tr>*{border-width:1px 0}
table.frame-all{border-width:1px}
table.frame-ends{border-width:1px 0}
table.frame-sides{border-width:0 1px}
table.frame-none>colgroup+*>:first-child>*,table.frame-sides>colgroup+*>:first-child>*{border-top-width:0}
table.frame-none>:last-child>:last-child>*,table.frame-sides>:last-child>:last-child>*{border-bottom-width:0}
table.frame-none>*>tr>:first-child,table.frame-ends>*>tr>:first-child{border-left-width:0}
table.frame-none>*>tr>:last-child,table.frame-ends>*>tr>:last-child{border-right-width:0}
table.stripes-all>*>tr,table.stripes-odd>*>tr:nth-of-type(odd),table.stripes-even>*>tr:nth-of-type(even),table.stripes-hover>*>tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
li>p:empty:only-child::before{content:"";display:inline-block}
ul.checklist>li>p:first-child{margin-left:-1em}
ul.checklist>li>p:first-child>.fa-square-o:first-child,ul.checklist>li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist>li>p:first-child>input[type=checkbox]:first-child{margin-right:.25em}
ul.inline{display:flex;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
td.hdlist2{word-wrap:anywhere}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:4px solid #fff;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);border-radius:50%;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt,summary{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt,summary{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]{border-bottom:1px dotted}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#header,#content,#footnotes,#footer{max-width:none}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media amzn-kf8,print{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
</head>
<body class="article toc2 toc-left">
<div id="header">
<h1>SPI Developer Guide</h1>
<div id="toc" class="toc2">
<div id="toctitle"></div>
<ul class="sectlevel1">
<li><a href="#_purpose_and_scope">Purpose and Scope</a></li>
<li><a href="#_choosing_the_deployment_layout">Choosing the deployment layout</a>
<ul class="sectlevel2">
<li><a href="#_microservices_deployment">Microservices Deployment</a></li>
</ul>
</li>
<li><a href="#_embedded_deployment">Embedded Deployment</a>
<ul class="sectlevel2">
<li><a href="#_embedding_xs2a_library">Embedding XS2A Library</a></li>
<li><a href="#_embedding_cms_library">Embedding CMS Library</a></li>
<li><a href="#_embedding_profile_library">Embedding Profile library</a></li>
</ul>
</li>
<li><a href="#_setting_up_aspsp_profile_options">Setting up ASPSP Profile options</a>
<ul class="sectlevel2">
<li><a href="#_configuring_payment_types_and_payment_products">Configuring Payment types and Payment products</a></li>
</ul>
</li>
<li><a href="#_configuring_sca_redirect_links">Configuring SCA redirect links</a></li>
<li><a href="#_configuring_sca_redirect_oauth">Configuring SCA Redirect OAuth</a>
<ul class="sectlevel2">
<li><a href="#_using_debug_interface">Using debug interface</a></li>
</ul>
</li>
<li><a href="#_implementing_spi_api">Implementing SPI-API</a>
<ul class="sectlevel2">
<li><a href="#_general_requirements">General requirements</a></li>
<li><a href="#_spiresponse">SpiResponse</a></li>
<li><a href="#_working_with_aspsp_consent_data_object">Working with ASPSP-Consent-Data object</a></li>
<li><a href="#_implementation_of_accountspi">Implementation of AccountSpi</a></li>
<li><a href="#_implementation_of_aisconsentspi">Implementation of AisConsentSpi</a></li>
<li><a href="#_providing_account_resources_to_consent">Providing account resources to consent</a></li>
<li><a href="#_implementation_of_fundsconfirmationspi">Implementation of FundsConfirmationSpi</a></li>
<li><a href="#_implementation_of_paymentspis">Implementation of PaymentSpi(s)</a></li>
<li><a href="#_strong_customer_authentication_sca">Strong Customer Authentication (SCA)</a></li>
<li><a href="#_multicurrency_accounts">Multicurrency Accounts</a></li>
<li><a href="#_get_spi_sca_status">Get SPI SCA status</a></li>
</ul>
</li>
<li><a href="#_configuring_xs2a_service">Configuring XS2A Service</a>
<ul class="sectlevel2">
<li><a href="#configuring-logging">Configuring Logging</a></li>
<li><a href="#propagating-request-information">Propagating information about the request from XS2A to external services</a></li>
<li><a href="#configuring-payment-validation-rules">Configuring payment validation rules</a></li>
<li><a href="#configuring-mapping-type-specific-payments-spi">Configuring mapping of type-specific payments for SPI</a></li>
<li><a href="#_configuring_xs2a_filters">Configuring XS2A filters</a></li>
</ul>
</li>
<li><a href="#_configuring_cms_service">Configuring CMS Service</a>
<ul class="sectlevel2">
<li><a href="#configuring-mapping-type-specific-payments-cms-apis">Configuring mapping of type-specific payments for CMS APIs</a></li>
</ul>
</li>
<li><a href="#_working_with_cms">Working with CMS</a>
<ul class="sectlevel2">
<li><a href="#_using_the_cms_psu_api">Using the CMS-PSU-API</a></li>
<li><a href="#_using_the_cms_aspsp_api">Using the CMS-ASPSP-API</a></li>
</ul>
</li>
<li><a href="#_upgrading_xs2a_instances_version_on_the_same_server">Upgrading XS2A instances version on the same server</a></li>
<li><a href="#_special_modes">Special modes</a>
<ul class="sectlevel2">
<li><a href="#_multi_tenancy_support">Multi-tenancy support</a></li>
<li><a href="#_support_multi_tenancy_in_xs2a">Support multi-tenancy in XS2A</a></li>
<li><a href="#_support_multi_tenancy_in_aspsp_profile">Support multi-tenancy in ASPSP Profile</a></li>
<li><a href="#_configure_event_service_in_embedded_mode">Configure Event-Service in embedded mode</a></li>
</ul>
</li>
<li><a href="#_certificate_generator">Certificate generator</a></li>
<li><a href="#_configuration_properties">Configuration properties</a>
<ul class="sectlevel2">
<li><a href="#_supported_configuration_properties">Supported configuration properties</a></li>
</ul>
</li>
<li><a href="#_multilevel_sca">Multilevel Sca</a></li>
<li><a href="#_extending_payment_validation">Extending payment validation</a></li>
</ul>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="_purpose_and_scope">Purpose and Scope</h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="_choosing_the_deployment_layout">Choosing the deployment layout</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_microservices_deployment">Microservices Deployment</h3>
<div class="paragraph">
<p>To deploy the XS2A service, one should use the following modules:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>ASPSP profile (static configuration for your ASPSP)</p>
</li>
<li>
<p>Consent Management System (basic entities CRUD services and underlying database to store them)</p>
</li>
<li>
<p>XS2A library itself (xs2a-impl, implementation of NextGenPSD2 Interface of Berlin Group)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Each of the specified components is a separate jar file (or several files) that can be deployed on web-server or in a docker container. Each
component can be started as a Spring Boot application and is written in Java 1.8 with Maven build system.</p>
</div>
<div class="paragraph">
<p>All of these can be deployed separately (using the network for communication) or as monolith in one server.
This setup depends on the current bank network configuration, data security and available hardware. More details can be
found at
<a href="../GETTING_STARTED.html">Getting started</a>
page.</p>
</div>
<div class="paragraph">
<p>These 3 services are basic configuration and to integrate them into whole ASPSP system one should use SPI implementation
(connector between XS2A and ASPSP system) and ASPSP system.</p>
</div>
<div class="paragraph">
<p>When XS2A services are deployed as microservices there is risk of getting error (e.g. service unavailable) when we interacting with them.
In this case the request should be protected against unavailability of remote services by catching <code>ResourceAccessException</code> error.
When writing custom filters it&#8217;s recommended to extend <code>GlobalAbstractExceptionFilter</code> class and write code in <code>doFilterInternalCustom</code> method that handles this error.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_embedded_deployment">Embedded Deployment</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_embedding_xs2a_library">Embedding XS2A Library</h3>
<div class="paragraph">
<p>In order to start Connector with embedded XS2A Library, one should use following annotations in SpringBootApplication:</p>
</div>
<div class="paragraph">
<p><code>@EnableXs2aSwagger</code></p>
</div>
<div class="paragraph">
<p><code>@EnableXs2aInterface</code></p>
</div>
<div class="paragraph">
<p>Also one needs following dependencies:</p>
</div>
<div class="paragraph">
<p><a href="https://github.com/adorsys/xs2a/releases">Choose your version of XS2A</a></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>&lt;properties&gt;
    &lt;xs2a.version&gt;7.9&lt;/xs2a.version&gt;
&lt;/properties&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>XS2A implementation</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>&lt;dependency&gt;
    &lt;groupId&gt;de.adorsys.psd2&lt;/groupId&gt;
    &lt;artifactId&gt;xs2a-impl&lt;/artifactId&gt;
    &lt;version&gt;${xs2a.version}&lt;/version&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p><a href="https://github.com/adorsys/xs2a/blob/develop/doc/SPI%20Developer%20Guide/Configuring%20XS2A%20Service.adoc#configuring-mapping-of-type-specific-payments-for-spi">Configuring mapping of type-specific payments for SPI</a></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>&lt;dependency&gt;
    &lt;groupId&gt;de.adorsys.psd2&lt;/groupId&gt;
    &lt;artifactId&gt;xs2a-payment-common-impl&lt;/artifactId&gt;
    &lt;version&gt;${xs2a.version}&lt;/version&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>In Connector you have to implement <a href="https://github.com/adorsys/xs2a/blob/develop/doc/SPI%20Developer%20Guide/Implementing%20SPI-API.adoc#implementing-spi-api">SPI-API</a></p>
</div>
<div class="paragraph">
<p>But for testing purposes you can use SPI-STUB</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>&lt;dependency&gt;
    &lt;groupId&gt;de.adorsys.psd2&lt;/groupId&gt;
    &lt;artifactId&gt;spi-stub&lt;/artifactId&gt;
    &lt;version&gt;${xs2a.version}&lt;/version&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you&#8217;ve chosen spi-stub, don&#8217;t forget add next annotation to app</p>
</div>
<div class="paragraph">
<p><code>@ComponentScan(basePackages = {"de.adorsys.psd2.stub"})</code></p>
</div>
<div class="paragraph">
<p><a href="https://github.com/adorsys/xs2a/blob/develop/doc/architecture/08_concepts.adoc#event-api-structure">Saving events in CMS database</a></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>&lt;dependency&gt;
    &lt;groupId&gt;de.adorsys.psd2&lt;/groupId&gt;
    &lt;artifactId&gt;event-service-rest-client&lt;/artifactId&gt;
    &lt;version&gt;${xs2a.version}&lt;/version&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Working with ASPSP Profile remotely</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>&lt;dependency&gt;
    &lt;groupId&gt;de.adorsys.psd2&lt;/groupId&gt;
    &lt;artifactId&gt;aspsp-profile-remote&lt;/artifactId&gt;
    &lt;version&gt;${xs2a.version}&lt;/version&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Working with CMS remotely</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>&lt;dependency&gt;
    &lt;groupId&gt;de.adorsys.psd2&lt;/groupId&gt;
    &lt;artifactId&gt;consent-xs2a-client&lt;/artifactId&gt;
    &lt;version&gt;${xs2a.version}&lt;/version&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Also to start project as web application add</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>&lt;dependency&gt;
    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
    &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Add following properties and change it when necessary:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>xs2a:
    endpoints:
        cors:
            # Whether credentials are supported. When not set, credentials are not supported.
            allow-credentials: false
            # Comma-separated list of origins to allow. '*' allows all origins. When not set, CORS support is disabled.
            allowed-origins: '*'
            # Comma-separated list of headers to include in a response.
            allowed-headers: '*'
            # Comma-separated list of methods to allow. '*' allows all methods. When not set, defaults to GET.
            allowed-methods: DELETE,GET,OPTIONS,PATCH,POST,PUT
            # How long, in seconds, the response from a pre-flight request can be cached by clients
            max-age: 3600
            # number of characters in a json string</code></pre>
</div>
</div>
<div class="paragraph">
<p>For testing purposes without real QWAC certificate, you can start application with <code>mock-qwac</code> profile.</p>
</div>
</div>
<div class="sect2">
<h3 id="_embedding_cms_library">Embedding CMS Library</h3>
<div class="paragraph">
<p>In order to start xs2a service with embedded CMS Library, one should use following annotations:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>@EnableTransactionManagement</code></p>
</li>
<li>
<p><code>@EntityScan({"de.adorsys.psd2.consent.domain", "de.adorsys.psd2.event.persist.entity"})</code></p>
</li>
<li>
<p><code>@EnableJpaRepositories(basePackages = {"de.adorsys.psd2.consent.repository", "de.adorsys.psd2.event"})</code></p>
</li>
<li>
<p><code>@ComponentScan(basePackages = {"de.adorsys.psd2.report"})</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Also one needs following dependencies:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>&lt;dependency&gt;
    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
    &lt;artifactId&gt;spring-boot-starter-data-jpa&lt;/artifactId&gt;
&lt;/dependency&gt;</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>&lt;dependency&gt;
    &lt;groupId&gt;de.adorsys.psd2&lt;/groupId&gt;
    &lt;artifactId&gt;consent-management-lib&lt;/artifactId&gt;
&lt;/dependency&gt;</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>&lt;dependency&gt;
    &lt;groupId&gt;de.adorsys.psd2&lt;/groupId&gt;
    &lt;artifactId&gt;cms-payment-support-impl&lt;/artifactId&gt;
&lt;/dependency&gt;</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>&lt;dependency&gt;
    &lt;groupId&gt;de.adorsys.psd2&lt;/groupId&gt;
    &lt;artifactId&gt;consent-psu-web&lt;/artifactId&gt;
&lt;/dependency&gt;</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>&lt;dependency&gt;
    &lt;groupId&gt;de.adorsys.psd2&lt;/groupId&gt;
    &lt;artifactId&gt;consent-aspsp-web&lt;/artifactId&gt;
&lt;/dependency&gt;</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>&lt;dependency&gt;
    &lt;groupId&gt;de.adorsys.psd2&lt;/groupId&gt;
    &lt;artifactId&gt;consent-xs2a-web&lt;/artifactId&gt;
&lt;/dependency&gt;</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>&lt;dependency&gt;
    &lt;groupId&gt;de.adorsys.psd2&lt;/groupId&gt;
    &lt;artifactId&gt;event-service-aspsp-impl&lt;/artifactId&gt;
&lt;/dependency&gt;</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>&lt;dependency&gt;
    &lt;groupId&gt;de.adorsys.psd2&lt;/groupId&gt;
    &lt;artifactId&gt;cms-scheduler-service&lt;/artifactId&gt;
&lt;/dependency&gt;</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>&lt;dependency&gt;
    &lt;groupId&gt;de.adorsys.psd2&lt;/groupId&gt;
    &lt;artifactId&gt;event-service-persist-db-impl&lt;/artifactId&gt;
&lt;/dependency&gt;</pre>
</div>
</div>
<div class="paragraph">
<p>And following properties:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Datasource settings:</p>
<div class="ulist">
<ul>
<li>
<p><code>spring.datasource.url</code></p>
</li>
<li>
<p><code>spring.datasource.username</code></p>
</li>
<li>
<p><code>spring.datasource.password</code></p>
</li>
</ul>
</div>
</li>
<li>
<p>JPA settings:</p>
<div class="ulist">
<ul>
<li>
<p><code>spring.jpa.properties.hibernate.default_schema</code></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>WARNING:</strong>  <code>For encryption\decryption of aspsp data we use secret server key ('server_key') which is read from Environment variables.
So, before starting project you need to create environment variables and set value, as example:  'server_key=12345678' or run app with this parameter</code></p>
</div>
</div>
<div class="sect2">
<h3 id="_embedding_profile_library">Embedding Profile library</h3>
<div class="paragraph">
<p>In order to start xs2a service with embedded APSPS Profile Library, one should add following dependencies:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>&lt;dependency&gt;
    &lt;groupId&gt;de.adorsys.psd2&lt;/groupId&gt;
    &lt;artifactId&gt;aspsp-profile-lib&lt;/artifactId&gt;
    &lt;version&gt;${project.version}&lt;/version&gt;
&lt;/dependency&gt;</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>&lt;dependency&gt;
    &lt;groupId&gt;de.adorsys.psd2&lt;/groupId&gt;
    &lt;artifactId&gt;aspsp-profile-web&lt;/artifactId&gt;
    &lt;version&gt;${project.version}&lt;/version&gt;
&lt;/dependency&gt;</pre>
</div>
</div>
<div class="paragraph">
<p>Also it&#8217;s required to add into <code>org.springframework.boot</code> plugin in pom file execution block:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>&lt;execution&gt;
    &lt;id&gt;build-info&lt;/id&gt;
    &lt;goals&gt;
        &lt;goal&gt;build-info&lt;/goal&gt;
    &lt;/goals&gt;
&lt;/execution&gt;</pre>
</div>
</div>
<div class="paragraph">
<p>Also, one needs to define property <code>xs2a.license.url</code>.</p>
</div>
<div class="paragraph">
<p>And if one have separate CMS service, that also communicates with ASPSP Profile, then one need to define property
<code>xs2a.cms.aspsp-profile.baseurl</code>.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_setting_up_aspsp_profile_options">Setting up ASPSP Profile options</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_configuring_payment_types_and_payment_products">Configuring Payment types and Payment products</h3>
<div class="sect3">
<h4 id="_how_to_add_new_custom_payment_product">How to add new custom payment-product</h4>
<div class="paragraph">
<p>Xs2a has implementation to support custom payment-products which are different from Berlin Group list.
To use for example "new-payment-product", open <strong>bank_profile.yaml</strong> and add it to <strong>supportedPaymentTypeAndProductMatrix</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>  SINGLE:
   - new-payment-product
  PERIODIC:
   - new-payment-product
  BULK:
   - new-payment-product</code></pre>
</div>
</div>
<div class="paragraph">
<p>Custom payment-products will be passed to SPI level through the interface <strong>de.adorsys.psd2.xs2a.spi.service.CommonPaymentSpi</strong>
Therefore this interface should be implemented in your SPI-Connector.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_configuring_sca_redirect_links">Configuring SCA redirect links</h2>
<div class="sectionbody">
<div class="paragraph">
<p>ASPSP is able to modify SCA redirect URLs for consent, payment and payment cancellation.</p>
</div>
<div class="paragraph">
<p>Redirect link for consent is constructed with <code>aisRedirectUrlToAspsp</code> parameter and can be configured with <code>{redirect-id}</code>, <code>{encrypted-consent-id}</code>, <code>{inr-id}</code> options.</p>
</div>
<div class="paragraph">
<p>Examples:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>"http://localhost/ais/{redirect-id}/{encrypted-consent-id}";</p>
</li>
<li>
<p>"http://localhost:4200/ais/{redirect-id}/{encrypted-consent-id}/{inr-id}";</p>
</li>
<li>
<p>"http://localhost:4200/ais/{redirect-id}".</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Redirect link for payment is constructed with  <code>pisRedirectUrlToAspsp</code> parameter and can be configured with <code>{redirect-id}</code>, <code>{encrypted-payment-id}</code>, <code>{inr-id}</code> options.</p>
</div>
<div class="paragraph">
<p>Examples:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>"http://localhost/pis/{redirect-id}/{encrypted-payment-id}";</p>
</li>
<li>
<p>"http://localhost:4200/pis/{redirect-id}/{encrypted-payment-id}/{inr-id}";</p>
</li>
<li>
<p>"http://localhost:4200/pis/{redirect-id}".</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Redirect link for payment cancellation is constructed with <code>pisPaymentCancellationRedirectUrlToAspsp</code> parameter and can be configured with the same options as for payment.</p>
</div>
<div class="paragraph">
<p>Examples:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>"http://localhost/pis/cancellation/{redirect-id}/{encrypted-payment-id}";</p>
</li>
<li>
<p>"http://localhost:4200/pis/cancellation/{redirect-id}/{encrypted-payment-id}/{inr-id}";</p>
</li>
<li>
<p>"http://localhost:4200/pis/cancellation/{redirect-id}".</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>All parameters are optional and can be omitted.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_configuring_sca_redirect_oauth">Configuring SCA Redirect OAuth</h2>
<div class="sectionbody">
<div class="paragraph">
<p>XS2A supports several modes of redirect SCA approach:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>redirect (usual redirect approach);</p>
</li>
<li>
<p>OAuth pre-step (TPP asks for token before initiation of the request);</p>
</li>
<li>
<p>OAuth integrated (TPP asks for token after initiation of the request).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Switching between these modes can be done by changing the <code>scaRedirectFlow</code> field value in the ASPSP profile. Possible
values for it are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>REDIRECT</code>;</p>
</li>
<li>
<p><code>OAUTH_PRE_STEP</code>;</p>
</li>
<li>
<p><code>OAUTH</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>OAUTH and OAUTH_PRE_STEP modes require link to identity provider (IDP) in the ASPSP profile. This is the field <code>oauthConfigurationUrl</code>.
It should be used for accessing third-party applications for providing the token.</p>
</div>
<div class="paragraph">
<p>Pre-step mode flow is the following. If token is present, then pre-step OAuth was already applied by TPP and XS2A returns link <code>scaRedirect</code>
to redirect PSU to online-banking (or other authorisation server) for SCA. If token is absent in initial request, XS2A returns
error <code>401 UNAUTHORIZED</code> with text <code>Please retrieve token first from {oauthConfigurationUrl}</code>.</p>
</div>
<div class="paragraph">
<p>Integrated mode: if ASPSP supports integrated OAuth and token is absent in initial request for consent, payment and payment
cancellation, XS2A returns link <code>scaOauth</code> (based on <code>oauthConfigurationUrl</code> in profile) to redirect TPP to IDP. If token
is present, XS2A responds with error <code>403 FORBIDDEN</code> with text <code>Token is not valid for the addressed service/resource</code>.</p>
</div>
<div class="sect2">
<h3 id="_using_debug_interface">Using debug interface</h3>
<div class="paragraph">
<p>The debug interface of the ASPSP profile enables the developer to update the list of supported SCA approaches and/or
ASPSP profile settings, temporarily during runtime. The changes won&#8217;t be persisted, and only stored in the local
application cache. Thus, these endpoints are unviable for a production environment and should only be used for
debugging, as a more convenient way of changing the SCA approaches and/or the ASPSP profile settings.</p>
</div>
<div class="paragraph">
<p>The debug interface is enabled via configuring Spring Profiles. The according profile name is <code>debug_mode</code>.</p>
</div>
<div class="paragraph">
<p>The endpoints provided are the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>POST /api/v1/aspsp-profile/for-debug/aspsp-settings</code> - Updates aspsp profile settings</p>
<div class="ulist">
<ul>
<li>
<p>Requires the ASPSP profile settings, in JSON format</p>
</li>
</ul>
</div>
</li>
<li>
<p><code>POST /api/v1/aspsp-profile/for-debug/sca-approaches</code> - Updates list of sca approaches</p>
<div class="ulist">
<ul>
<li>
<p>Requires the SCA approaches, as separated Strings, in a JSON array</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>From v.5.x onwards there is one additional endpoint that is accesible in the scope of <code>debug-mode</code>. This endpoint allows
the customer to change an old ASPSP-Profile (prior to v.5.x) to a newer version, which improves readability and
structures the settings more rigorously.</p>
</div>
<div class="paragraph">
<p>The endpoint containing this behavior is accesible via:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>POST /api/v1/aspsp-profile/convert-profile/aspsp-settings</code> - Converts old aspsp profile to the new format</p>
<div class="ulist">
<ul>
<li>
<p>Requires the, v.4.x. and prior, ASPSP profile settings, in YAML format</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_implementing_spi_api">Implementing SPI-API</h2>
<div class="sectionbody">
<!-- toc disabled -->
<div class="sect2">
<h3 id="_general_requirements">General requirements</h3>
<div class="paragraph">
<p><strong>SPI</strong> means Service Provider Interface that is an API intended to be implemented or extended by a third party.
SPI-API is used for connection between XS2A interface and ASPSP system, that&#8217;s why this system is also called <strong>connector</strong>
and this word will be used in all chapters below.
XS2A provides interfaces in java (<strong>de.adorsys.psd2.xs2a.spi.service</strong> package), that should be implemented in the connector&#8217;s code.</p>
</div>
<div class="paragraph">
<p>Basic responsibilities of the connector:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>receive the input data from XS2A;</p>
</li>
<li>
<p>provide this data to the ASPSP system (and/or add some business logic, if necessary);</p>
</li>
<li>
<p>retrieve the response from ASPSP system;</p>
</li>
<li>
<p>provide the ASPSP system&#8217;s response back to XS2A using <strong>SpiResponse</strong> class.</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_spi_methods_common_parameters">SPI methods common parameters</h4>
<div class="paragraph">
<p>Input data for the connector is provided from TPP through XS2A and some parameters in the interfaces' signatures
are common for all of them:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>spiContextData</strong> - the information about PSU and TPP;</p>
</li>
<li>
<p><strong>spiAspspConsentDataProvider</strong> - this service is used for providing ASPSP consent data to connector and ASPSP system.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Other method-specific parameters are described in the chapters below.</p>
</div>
<div class="paragraph">
<p>Speaking about <strong>SpiContextData</strong> - first, it contains the <strong>psuData</strong> object. It stores data about PSU known in scope of the request:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Attribute</th>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Condition</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">psuId</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Conditional</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Client ID of the PSU in the ASPSP client interface</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">psuIdType</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Conditional</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Type of the psuId, needed in scenarios where PSUs have several psuIds as access possibility</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">psuCorporateId</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Conditional</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Identification of a corporate in the online Channels. Might be mandated in the ASPSP’s documentation. Only used in a corporate context</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">psuCorporateIdType</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Conditional</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">This is describing the type of the identification needed by the ASPSP to identify the psuCorporateId</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Another parameter in <strong>SpiContextData</strong> is the <strong>tppInfo</strong>. It contains information about the TPP&#8217;s certificate:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>"Registration number": example = "1234_registrationNumber";</p>
</li>
<li>
<p>"TPP name": example = "Tpp company";</p>
</li>
<li>
<p>"National competent authority": example = "Bafin";</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Also, <strong>SpiContextData</strong> object stores the OAuth2 token in the <strong>oAuth2Token</strong> field - this is the authorisation token
that should be present
in any XS2A request during OAuth SCA approach. This header is passed to SPI level in each method.</p>
</div>
<div class="paragraph">
<p>There are a few optional fields in <strong>SpiContextData</strong>, which can be sent as headers in request by TPP:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Attribute</th>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Condition</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">tppBrandLoggingInformation</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Optional</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">This parameter might be used by TPPs to inform the ASPSP about
the brand used by the TPP towards the PSU.
This information is meant for logging entries to enhance communication between ASPSP and PSU or ASPSP and TPP.
This parameter might be ignored by the ASPSP.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">tppRejectionNoFundsPreferred</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Boolean</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Optional</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If it equals "true" then the TPP prefers a rejection of the
payment initiation in case the ASPSP is providing an integrated confirmation of funds request an the result of this
is that not sufficient funds are available.
If it equals "false" then the TPP prefers that the ASPSP is dealing with the payment initiation like in the ASPSPs
online channel, potentially waiting for a certain time period for funds to arrive to initiate the payment.
This parameter may be ignored by the ASPSP.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">tppRedirectPreferred</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Boolean</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Optional</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If it equals "true", the TPP prefers a redirect over an embedded SCA
approach.
If it equals "false", the TPP prefers not to be redirected for SCA. The ASPSP will then choose between the Embedded
or the Decoupled SCA approach, depending on the parameter TPP- Decoupled-Preferred and the choice of the SCA
procedure by the TPP/PSU.
If the parameter is not used, the ASPSP will choose the SCA approach to be applied depending on the SCA method
chosen by the TPP/PSU.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">tppDecoupledPreferred</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Boolean</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Optional</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If it equals "true", the TPP prefers a decoupled SCA approach.
If it equals "false", the TPP prefers not to use the decoupled approach for SCA. The ASPSP will then choose
between the embedded or the redirect SCA approach, depending on the choice of the SCA procedure by the TPP/PSU.
If the parameter is not used, the ASPSP will choose the SCA approach to be applied depending on the parameter
TPP-Redirect- Preferred and the SCA method chosen by the TPP/PSU.
The parameter might be ignored by the ASPSP.
If both parameters TPP-Redirect-Preferred and TPP-Decoupled-Preferred are present and true, the request is still
not rejected, but it is up to the ASPSP, which approach will actually be used.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The response from the connector to XS2A and the ASPSP consent data provider are described in the next chapters.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_spiresponse">SpiResponse</h3>
<div class="paragraph">
<p>This class acts as the container for all responses from the connector to XS2A. It is a generic class and it uses builder
pattern to create the response. Main fields of the class:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>T payload</strong>;</p>
</li>
<li>
<p><strong>List&lt;TppMessage&gt; errors</strong>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>payload</strong> should be used to create successful response to XS2A. It should contain the object which current SPI method deals with.
<strong>errors</strong> should be used in case the response fails. The list should contain at least one error element inside the <strong>TppMessage</strong>
container. It is possible to provide several errors, if necessary. <strong>build()</strong> method should be used to create SpiResponse
after setting payload or errors. Typical usage of builder pattern for happy-path response:</p>
</div>
<div class="paragraph">
<p><strong>return SpiResponse.&lt;SpiAuthorisationStatus&gt;builder()
                   .payload(SpiAuthorisationStatus.SUCCESS)
                   .build();</strong></p>
</div>
<div class="paragraph">
<p>In this example the <strong>SpiAuthorisationStatus</strong> enumerator value is returned.</p>
</div>
</div>
<div class="sect2">
<h3 id="_working_with_aspsp_consent_data_object">Working with ASPSP-Consent-Data object</h3>
<div class="paragraph">
<p>ASPSP consent data is a container that allows to handle any information about the consent or payment in scope of SPI level calls.
More detailed clarification about this object can be found
<a href="../architecture/09_design_decisions.html">here</a>.
XS2A provides a special interface for working with the ASPSP consent data - <strong>de.adorsys.psd2.xs2a.spi.domain.SpiAspspConsentDataProvider</strong>.
This interface has 3 methods:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>loadAspspConsentData</strong> to retrieve the ASPSP consent data;</p>
</li>
<li>
<p><strong>updateAspspConsentData</strong> to update this data;</p>
</li>
<li>
<p><strong>clearAspspConsentData</strong> to erase the ASPSP consent data.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This interface has the implementation: <strong>SpiAspspConsentDataProviderImpl</strong>. It should be used while working with
the existing entity of AIS consent or payment (by providing its ID) in the connector.
One should understand that it is SPI developer responsibility to update (or not) the ASPSP consent data on the connector side.
XS2A just provides a possibility to make these changes by passing the <strong>SpiAspspConsentDataProvider</strong> object to every SPI method.
Please note, that XS2A just stores this data in CMS as a byte array field and does not use it. Definite ASPSP consent data is
tied to the definite AIS consent or payment and stored in aspsp_consent_data CMS table.</p>
</div>
<div class="paragraph">
<p>From the connector side typical code for working with the ASPSP consent data during any SPI implementation method is the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>byte[] initialAspspConsentData = aspspConsentDataProvider.loadAspspConsentData();</strong> - to retrieve the data;</p>
</li>
<li>
<p><strong>aspspConsentDataProvider.updateAspspConsentData("Some text data to be stored".getBytes());</strong> - to update the data with the new one.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_implementation_of_accountspi">Implementation of AccountSpi</h3>
<div class="paragraph">
<p>The Interface is used for AIS consent accounts SPI implementation. The following methods should be implemented:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>requestAccountList</strong>;</p>
</li>
<li>
<p><strong>requestAccountDetailForAccount</strong>;</p>
</li>
<li>
<p><strong>requestTransactionsForAccount</strong>;</p>
</li>
<li>
<p><strong>requestTransactionForAccountByTransactionId</strong>;</p>
</li>
<li>
<p><strong>requestBalancesForAccount</strong>;</p>
</li>
<li>
<p><strong>requestTransactionsByDownloadLink</strong>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The method <strong>requestAccountList</strong> provides a possibility to retrieve the list of account details by given AIS consent ID and boolean flag <strong>withBalance</strong>.
Parameters of the method are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>spiContextData</strong>;</p>
</li>
<li>
<p><strong>withBalance</strong> - this flag specifies if the balances would be present in the response or not;</p>
</li>
<li>
<p><strong>spiAccountConsent</strong>;</p>
</li>
<li>
<p><strong>spiAspspConsentDataProvider</strong>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Response is a list containing the <strong>SpiAccountDetails</strong> entities.</p>
</div>
<div class="paragraph">
<p>The method <strong>requestAccountDetailForAccount</strong> provides a possibility to retrieve the data for the definite account by given consent ID,
account ID (obtained from the previous method) and boolean flag <strong>withBalance</strong>. Flag&#8217;s operation is the same as above. Parameters are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>spiContextData</strong>;</p>
</li>
<li>
<p><strong>withBalance</strong> - this flag specifies if the balances would be present in the response or not;</p>
</li>
<li>
<p><strong>spiAccountReference</strong> - holder for account ID;</p>
</li>
<li>
<p><strong>spiAccountConsent</strong>;</p>
</li>
<li>
<p><strong>spiAspspConsentDataProvider</strong>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Response is the <strong>SpiAccountDetails</strong> object.</p>
</div>
<div class="paragraph">
<p>The method <strong>requestTransactionsForAccount</strong> provides a possibility to retrieve the list of bank transactions filtered by the period,
AIS consent account ID, status and other parameters. Parameters are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>spiContextData</strong>;</p>
</li>
<li>
<p><strong>spiTransactionReportParameters</strong> - additional parameters for retrieving transaction list (e.g. acceptMediaType, withBalance, dateFrom, dateFrom, bookingStatus, entryReferenceFrom, deltaList);</p>
</li>
<li>
<p><strong>spiAccountReference</strong> - holder for account ID;</p>
</li>
<li>
<p><strong>spiAccountConsent</strong>;</p>
</li>
<li>
<p><strong>spiAspspConsentDataProvider</strong>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The response is <strong>SpiTransactionReport</strong> object. It also provides the transaction list download ID, which can be used to
download a file with the list of bank transactions.</p>
</div>
<div class="paragraph">
<p>The method <strong>requestTransactionForAccountByTransactionId</strong> provides a possibility to retrieve the data about the bank transaction
by the given transaction ID (can be obtained from the previous method). Parameters:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>spiContextData</strong>;</p>
</li>
<li>
<p><strong>transactionId</strong> - ID of bank transaction;</p>
</li>
<li>
<p><strong>spiAccountReference</strong> - holder for account ID;</p>
</li>
<li>
<p><strong>spiAccountConsent</strong>;</p>
</li>
<li>
<p><strong>spiAspspConsentDataProvider</strong>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Response is <strong>SpiTransaction</strong> object.</p>
</div>
<div class="paragraph">
<p>The method <strong>requestBalancesForAccount</strong> provides a possibility to retrieve the list of balances for the given account by its ID.
Parameters are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>spiContextData</strong>;</p>
</li>
<li>
<p><strong>spiAccountReference</strong> - holder for account ID;</p>
</li>
<li>
<p><strong>spiAccountConsent</strong>;</p>
</li>
<li>
<p><strong>spiAspspConsentDataProvider</strong>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Response is a list with <strong>SpiAccountBalance</strong> objects.</p>
</div>
<div class="paragraph">
<p>The method <strong>requestTransactionsByDownloadLink</strong> allows to download a list of bank transactions directly to the file. Its
parameters are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>spiContextData</strong>;</p>
</li>
<li>
<p><strong>spiAccountConsent</strong>;</p>
</li>
<li>
<p><strong>downloadId</strong> - identifier for downloading the file (can be retrieved from the <strong>requestTransactionsForAccount</strong> SPI method call);</p>
</li>
<li>
<p><strong>spiAspspConsentDataProvider</strong>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>It returns <strong>SpiTransactionsDownloadResponse</strong> object with the InputStream which contains the transaction list, filename (can be null)
and the size of the payload in bytes (can be null also).
From the TPP side the download can be initiated by accessing new endpoint in account controller - <strong>GET /v1/accounts/{account-id}/transactions/download/{download-id}</strong>.
TPP should provide the AIS consent account ID and the download ID. As a response for accessing this endpoint, the TPP
receives the stream with transaction list.</p>
</div>
</div>
<div class="sect2">
<h3 id="_implementation_of_aisconsentspi">Implementation of AisConsentSpi</h3>
<div class="paragraph">
<p>The Interface is used for AIS consent SPI implementation. The following methods should be implemented:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>initiateAisConsent</strong>;</p>
</li>
<li>
<p><strong>getConsentStatus</strong>;</p>
</li>
<li>
<p><strong>revokeAisConsent</strong>;</p>
</li>
<li>
<p><strong>verifyScaAuthorisation</strong>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The method <strong>initiateAisConsent</strong> provides a possibility to create a new AIS consent from the provided data. Parameters of the method are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>spiContextData</strong>;</p>
</li>
<li>
<p><strong>spiAccountConsent</strong> - provided data about the AIS consent from CMS;</p>
</li>
<li>
<p><strong>spiAspspConsentDataProvider</strong>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Response is a <strong>SpiInitiateAisConsentResponse</strong> object.</p>
</div>
<div class="paragraph">
<p>The method <strong>getConsentStatus</strong> provides a possibility to retrieve the consent status. Parameters of the method are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>spiContextData</strong>;</p>
</li>
<li>
<p><strong>spiAccountConsent</strong> - provided data about the AIS consent from CMS;</p>
</li>
<li>
<p><strong>spiAspspConsentDataProvider</strong>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Response is a <strong>SpiAisConsentStatusResponse</strong> object with status and PSU message (optional).</p>
</div>
<div class="paragraph">
<p>The method <strong>revokeAisConsent</strong> provides a possibility to revoke the given AIS consent (change its status to <code>REJECTED</code> or
<code>TERMINATED_BY_TPP</code>). Parameters of the method are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>spiContextData</strong>;</p>
</li>
<li>
<p><strong>spiAccountConsent</strong> - provided data about the AIS consent from CMS;</p>
</li>
<li>
<p><strong>spiAspspConsentDataProvider</strong>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Response is empty (<code>VoidResponse</code> object).</p>
</div>
<div class="paragraph">
<p>The method <strong>verifyScaAuthorisation</strong> provides a possibility to send information about the authorisation confirmation (e.g. transaction
authorisation number or some other security code) to ASPSP. This method is used only with embedded SCA Approach. Parameters of the method are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>spiContextData</strong>;</p>
</li>
<li>
<p><strong>SpiScaConfirmation</strong> - the information about the definite consent (its ID), corresponding PSU data and security code.</p>
</li>
<li>
<p><strong>spiAccountConsent</strong> - provided data about the AIS consent from CMS;</p>
</li>
<li>
<p><strong>spiAspspConsentDataProvider</strong>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Response is a <strong>SpiVerifyScaAuthorisationResponse</strong> object that stores the status of operation.</p>
</div>
<div class="paragraph">
<p>Among the methods that were described above, this interface extends <strong>AuthorisationSpi</strong>, its methods are described below in the
<strong>PaymentAuthorisationSpi</strong> chapter.</p>
</div>
</div>
<div class="sect2">
<h3 id="_providing_account_resources_to_consent">Providing account resources to consent</h3>
<div class="paragraph">
<p>Speaking about the AIS consent SPI implementation, please note that TPP can create the consent with provided account reference
data (such consent is called <code>dedicated consent</code>) or without one (<code>global</code> or <code>bank offered</code> consent). If the consent was
created without account reference data there is a possibility to fill it through the CMS-PSU-API after. The CMS endpoint
<code>/psu-api/v1/ais/consent/{internal_consent_id}/save-access</code> provides such functionality. Path parameter <code>internal_consent_id</code> should
be the internal CMS consent identifier. The body of this request should contain the JSON representation of account reference,
for example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-json" data-lang="json">{
    "accountAccess": {
        "accounts": [
            {
                "iban": "DE80760700240271232400",
                "currency": "EUR"
            }
        ],
        "balances": [
            {
                "iban": "DE80760700240271232400",
                "currency": "EUR"
            }
        ],
        "transactions": [
            {
                "iban": "DE80760700240271232400",
                "currency": "EUR"
            }
        ]
    },
    "frequencyPerDay": 100,
    "validUntil": "2019-12-31"
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>After this operation the given consent&#8217;s account reference data will be updated in CMS and the consent may be confirmed as usual.</p>
</div>
</div>
<div class="sect2">
<h3 id="_implementation_of_fundsconfirmationspi">Implementation of FundsConfirmationSpi</h3>
<div class="paragraph">
<p>This interface is used for retrieving information from ASPSP in scope of Confirmation of Funds requests.</p>
</div>
<div class="paragraph">
<p><strong>FundsConfirmationSpi</strong> contains only one method that should be implemented - <strong>performFundsSufficientCheck</strong>, which is responsible for checking whether requested account has sufficient funds.
The method returns <strong>SpiFundsConfirmationResponse</strong> as part of <strong>SpiResponse</strong> with information whether the requested amount can be booked on the account.</p>
</div>
<div class="paragraph">
<p><strong>performFundsSufficientCheck</strong> takes the following arguments:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>spiContextData</strong> - information about the context of the call</p>
</li>
<li>
<p><strong>spiPiisConsent</strong> - optional PIIS consent object, will be absent if the request is done from a workflow without the consent</p>
</li>
<li>
<p><strong>spiFundsConfirmationRequest</strong> - information about the account and transaction amount, provided by the TPP</p>
</li>
<li>
<p><strong>aspspConsentDataProvider</strong> - optional ASPSP consent data provider, will be absent if the request is done from a workflow without the consent</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>PIIS consent will be passed to the SPI method along with ASPSP consent data provider if the ASPSP supports PIIS consents.
Otherwise both PIIS consent object and ASPSP consent data provider will be absent in the request to SPI.</p>
</div>
</div>
<div class="sect2">
<h3 id="_implementation_of_paymentspis">Implementation of PaymentSpi(s)</h3>
<div class="paragraph">
<p>We distinguish between following interfaces: <strong>SinglePaymentSpi</strong>, <strong>BulkPaymentSpi</strong>, <strong>PeriodicPaymentSpi</strong>, <strong>CommonPaymentSpi</strong>, <strong>PaymentAuthorisationSpi</strong>, <strong>PaymentCancellationSpi</strong>.</p>
</div>
<div class="sect3">
<h4 id="_singlepaymentspi">SinglePaymentSpi</h4>
<div class="paragraph">
<p>The Interface is used for the single payment SPI implementation. The following Methods should be implemented:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>initiatePayment</strong>: aims to initiate a payment;</p>
</li>
<li>
<p><strong>getPaymentById</strong>: aims to read the payment by ID;</p>
</li>
<li>
<p><strong>getPaymentStatusById</strong>: aims to read the payment status by ID and PSU message (optional);</p>
</li>
<li>
<p><strong>executePaymentWithoutSca</strong>: executes payment without SCA;</p>
</li>
<li>
<p><strong>verifyScaAuthorisationAndExecutePayment</strong>: verifies SCA authorisation and executes payment.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The method <strong>initiatePayment</strong> returns a positive or negative payment initiation response (<strong>SpiSinglePaymentInitiationResponse</strong>
object) as a part of SpiResponse. Method signature contains the following (description of basic fields <strong>SpiContextData</strong> and
<strong>SpiAspspConsentDataProvider</strong> is provided above):</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>spiContextData</strong>;</p>
</li>
<li>
<p><strong>spiSinglePayment</strong>: payment, that extends SpiPayment (Single Payment) and has fields required for business logic;</p>
</li>
<li>
<p><strong>spiAspspConsentDataProvider</strong>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Response by the method <strong>getPaymentById</strong> returns payment as a part of SpiResponse (<strong>SpiSinglePayment</strong> object) and contains
 the following data:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>spiContextData</strong>;</p>
</li>
<li>
<p><strong>acceptMediaType</strong>: media type requested by the TPP;</p>
</li>
<li>
<p><strong>payment</strong>: Single Payment;</p>
</li>
<li>
<p><strong>spiAspspConsentDataProvider</strong>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Response by the method <strong>getPaymentStatusById</strong> returns the <strong>SpiGetPaymentStatusResponse</strong> object (with the transaction status)
and contains the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>spiContextData</strong>;</p>
</li>
<li>
<p><strong>acceptMediaType</strong>: media type requested by the TPP;</p>
</li>
<li>
<p><strong>payment</strong>: Single Payment;</p>
</li>
<li>
<p><strong>spiAspspConsentDataProvider</strong>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>executePaymentWithoutSca</strong> method is used for executing payment when no SCA is required.
Returns a <strong>SpiPaymentExecutionResponse</strong> object with appropriate transaction status and has the following parameters:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>spiContextData</strong>;</p>
</li>
<li>
<p><strong>payment</strong>: Single Payment;</p>
</li>
<li>
<p><strong>spiAspspConsentDataProvider</strong>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>verifyScaAuthorisationAndExecutePayment</strong> is used for verifying SCA and executing payment.
Returns a <strong>SpiPaymentExecutionResponse</strong> object with appropriate transaction status and has the following parameters:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>spiContextData</strong>;</p>
</li>
<li>
<p><strong>spiScaConfirmation</strong>: data for verifying SCA;</p>
</li>
<li>
<p><strong>payment</strong>: Single Payment;</p>
</li>
<li>
<p><strong>spiAspspConsentDataProvider</strong>.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_periodicpaymentspi">PeriodicPaymentSpi</h4>
<div class="paragraph">
<p>The Interface is used for periodic payments for SPI implementation. The following methods should be implemented:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>initiatePayment</strong>;</p>
</li>
<li>
<p><strong>getPaymentById</strong>;</p>
</li>
<li>
<p><strong>getPaymentStatusById</strong>;</p>
</li>
<li>
<p><strong>executePaymentWithoutSca</strong>;</p>
</li>
<li>
<p><strong>verifyScaAuthorisationAndExecutePayment</strong>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The method <strong>initiatePayment</strong> returns a positive or negative payment initiation response (<strong>SpiPeriodicPaymentInitiationResponse</strong>)
as a part of SpiResponse and contains the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>spiContextData</strong>;</p>
</li>
<li>
<p><strong>payment</strong>: Periodic Payment;</p>
</li>
<li>
<p><strong>spiAspspConsentDataProvider</strong>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Response by the method <strong>getPaymentById</strong> returns payment as a part of SpiResponse (<strong>SpiPeriodicPayment</strong>) and contains the following data:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>spiContextData</strong>;</p>
</li>
<li>
<p><strong>acceptMediaType</strong>: media type requested by the TPP;</p>
</li>
<li>
<p><strong>payment</strong>: Periodic Payment;</p>
</li>
<li>
<p><strong>spiAspspConsentDataProvider</strong>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Response by the method <strong>getPaymentStatusById</strong> returns the <strong>SpiGetPaymentStatusResponse</strong> with the transaction status
and PSU message (optional) and contains the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>spiContextData</strong>;</p>
</li>
<li>
<p><strong>acceptMediaType</strong>: media type requested by the TPP;</p>
</li>
<li>
<p><strong>payment</strong>: Periodic Payment;</p>
</li>
<li>
<p><strong>spiAspspConsentDataProvider</strong>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>executePaymentWithoutSca</strong> method is used for executing payment when no SCA is required.
Returns a <strong>SpiPaymentExecutionResponse</strong> object with appropriate transaction status and has the following parameters:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>spiContextData</strong>;</p>
</li>
<li>
<p><strong>payment</strong>: Periodic Payment;</p>
</li>
<li>
<p><strong>spiAspspConsentDataProvider</strong>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>verifyScaAuthorisationAndExecutePayment</strong> is used for verifying SCA and executing payment.
Returns a <strong>SpiPaymentExecutionResponse</strong> object with appropriate transaction status and has the following parameters:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>spiContextData</strong>;</p>
</li>
<li>
<p><strong>spiScaConfirmation</strong>: data for verifying SCA;</p>
</li>
<li>
<p><strong>payment</strong>: Periodic Payment;</p>
</li>
<li>
<p><strong>spiAspspConsentDataProvider</strong>.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_bulkpaymentspi">BulkPaymentSpi</h4>
<div class="paragraph">
<p>The Interface is used for bulk payments for SPI implementation. The following methods should be implemented:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>initiatePayment</strong>;</p>
</li>
<li>
<p><strong>getPaymentById</strong>;</p>
</li>
<li>
<p><strong>getPaymentStatusById</strong>;</p>
</li>
<li>
<p><strong>executePaymentWithoutSca</strong>;</p>
</li>
<li>
<p><strong>verifyScaAuthorisationAndExecutePayment</strong>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The method <strong>initiatePayment</strong> returns a positive or negative payment initiation response (<strong>SpiBulkPaymentInitiationResponse</strong>)
as a part of SpiResponse and contains the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>spiContextData</strong>;</p>
</li>
<li>
<p><strong>payment</strong>: Bulk Payment;</p>
</li>
<li>
<p><strong>spiAspspConsentDataProvider</strong>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Response by the method <strong>getPaymentById</strong> returns payment as a part of SpiResponse (<strong>SpiBulkPayment</strong>) and contains the
following data:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>spiContextData</strong>;</p>
</li>
<li>
<p><strong>acceptMediaType</strong>: media type requested by the TPP;</p>
</li>
<li>
<p><strong>payment</strong>: Bulk Payment;</p>
</li>
<li>
<p><strong>spiAspspConsentDataProvider</strong>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Response by the methods <strong>getPaymentStatusById</strong> returns the <strong>SpiGetPaymentStatusResponse</strong> object with the transaction status
and PSU message (optional) and contains the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>spiContextData</strong>;</p>
</li>
<li>
<p><strong>acceptMediaType</strong>: media type requested by the TPP;</p>
</li>
<li>
<p><strong>payment</strong>: Bulk Payment;</p>
</li>
<li>
<p><strong>spiAspspConsentDataProvider</strong>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>executePaymentWithoutSca</strong> method is used for executing payment when no SCA is required.
Returns a <strong>SpiPaymentExecutionResponse</strong> object with appropriate transaction status and has the following parameters:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>spiContextData</strong>;</p>
</li>
<li>
<p><strong>payment</strong>: Bulk Payment;</p>
</li>
<li>
<p><strong>spiAspspConsentDataProvider</strong>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>verifyScaAuthorisationAndExecutePayment</strong> is used for verifying SCA and executing payment.
Returns a <strong>SpiPaymentExecutionResponse</strong> object with appropriate transaction status and has the following parameters:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>spiContextData</strong>;</p>
</li>
<li>
<p><strong>spiScaConfirmation</strong>: data for verifying SCA;</p>
</li>
<li>
<p><strong>payment</strong>: Bulk Payment;</p>
</li>
<li>
<p><strong>spiAspspConsentDataProvider</strong>.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_commonpaymentspi">CommonPaymentSpi</h4>
<div class="paragraph">
<p>The Interface is used for common payments SPI implementation.</p>
</div>
<div class="paragraph">
<p>This interface will be called instead of other payment SPI interfaces if the affected payment is considered to be a common one.
Depending on <a href="#configuring-mapping-type-specific-payments-spi">mapping configuration of payments for SPI</a> this can mean either all payments, or only payments with any payment product that doesn&#8217;t belong to the pre-defined list of standard JSON payment products (regardless of payment service or content type).</p>
</div>
<div class="paragraph">
<p>The following methods should be implemented:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>initiatePayment</strong>: initiates a payment;</p>
</li>
<li>
<p><strong>getPaymentById</strong>: reads the payment by ID;</p>
</li>
<li>
<p><strong>getPaymentStatusById</strong>: reads the payment status by ID;</p>
</li>
<li>
<p><strong>executePaymentWithoutSca</strong>: executes payment without SCA;</p>
</li>
<li>
<p><strong>verifyScaAuthorisationAndExecutePayment</strong>: verifies SCA authorisation and executes payment.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The method <strong>initiatePayment</strong> is being called on initiating any common payment.
Returns a positive or negative payment initiation response (<strong>SpiPaymentInitiationResponse</strong>) as a part of SpiResponse and has the following parameters:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>spiContextData</strong>;</p>
</li>
<li>
<p><strong>payment</strong>: common payment object;</p>
</li>
<li>
<p><strong>spiAspspConsentDataProvider</strong>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>getPaymentById</strong> method returns payment as a part of SpiResponse (<strong>SpiPaymentInfo</strong>) and has the following parameters:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>spiContextData</strong>;</p>
</li>
<li>
<p><strong>acceptMediaType</strong>: media type requested by the TPP;</p>
</li>
<li>
<p><strong>payment</strong>: common payment object;</p>
</li>
<li>
<p><strong>spiAspspConsentDataProvider</strong>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>getPaymentStatusById</strong> method returns a <strong>SpiGetPaymentStatusResponse</strong> object with the transaction status and PSU
message (optional) and has the following parameters:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>spiContextData</strong>;</p>
</li>
<li>
<p><strong>acceptMediaType</strong>: media type requested by the TPP;</p>
</li>
<li>
<p><strong>payment</strong>: common payment object;</p>
</li>
<li>
<p><strong>spiAspspConsentDataProvider</strong>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>executePaymentWithoutSca</strong> method is used for executing payment when no SCA is required.
Returns a <strong>SpiPaymentExecutionResponse</strong> object with appropriate transaction status and has the following parameters:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>spiContextData</strong>;</p>
</li>
<li>
<p><strong>payment</strong>: common payment object;</p>
</li>
<li>
<p><strong>spiAspspConsentDataProvider</strong>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>verifyScaAuthorisationAndExecutePayment</strong> is used for verifying SCA and executing payment.
Returns a <strong>SpiPaymentExecutionResponse</strong> object with appropriate transaction status and has the following parameters:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>spiContextData</strong>;</p>
</li>
<li>
<p><strong>spiScaConfirmation</strong>: data for verifying SCA;</p>
</li>
<li>
<p><strong>payment</strong>: common payment object;</p>
</li>
<li>
<p><strong>spiAspspConsentDataProvider</strong>.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_paymentauthorisationspi">PaymentAuthorisationSpi</h4>
<div class="paragraph">
<p>The Interface is used while implementing payment authorisation flow on SPI level. This Interface is implemented by extending the <strong>AuthorisationSpi</strong>. The following Methods should be implemented:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>authorisePsu</strong>;</p>
</li>
<li>
<p><strong>requestAvailableScaMethods</strong>;</p>
</li>
<li>
<p><strong>requestAuthorisationCode</strong>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The Method <strong>authorisePsu</strong> authorises PSU and returns current (success or failure) authorisation status with <strong>scaExempted</strong> flag.
This flag is taken into account by XS2A for performing SCA exemption.
If the PSU authorisation SPI response for bulk or single payment will be successful and <strong>scaExempted</strong> is <strong>true</strong>
- SCA will not be performed will be invoked and authorisation status will be set to <strong>EXEMPTED</strong>. SCA exemption is supported for multilevel SCA too.</p>
</div>
<div class="paragraph">
<p><strong>The Method authorisePsu should be used only with Embedded SCA Approach</strong>. It contains following Data:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>spiContextData</strong>;</p>
</li>
<li>
<p><strong>psuLoginData</strong>: ASPSP identifier(s) of the PSU, provided by TPP within this request;</p>
</li>
<li>
<p><strong>password</strong>: PSU&#8217;s password;</p>
</li>
<li>
<p><strong>businessObject</strong>: payment object;</p>
</li>
<li>
<p><strong>spiAspspConsentDataProvider</strong>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The Method <strong>requestAvailableScaMethods</strong> returns a list of SCA methods for the PSU by its login. <strong>Should be used only with the Embedded SCA Approach</strong>. It contains following Data:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>spiContextData</strong>;</p>
</li>
<li>
<p><strong>businessObject</strong>;</p>
</li>
<li>
<p><strong>spiAspspConsentDataProvider</strong>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The Method <strong>requestAuthorisationCode</strong> performs SCA depending on selected SCA method. <strong>Should be used only with Embedded Approach</strong>. Method returns a positive or negative response as a part of SpiResponse.
If the authentication method is unknown, then empty <strong>SpiAuthorizationCodeResult</strong> should be returned. It contains following data:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>spiContextData</strong>;</p>
</li>
<li>
<p><strong>businessObject</strong>;</p>
</li>
<li>
<p><strong>spiAspspConsentDataProvider</strong>.</p>
</li>
<li>
<p><strong>authenticationMethodId</strong>: ID of a chosen SCA method.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In case of <strong>Decoupled SCA Approach</strong>, the method <strong>startScaDecoupled</strong> has to be implemented: method notifies a decoupled application
about starting SCA. AuthorisationId is provided to allow the app to access CMS. It returns a response object, contains a
message from ASPSP to PSU, gives him instructions regarding decoupled SCA starting. It contains the following data:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>spiContextData</strong>;</p>
</li>
<li>
<p><strong>businessObject</strong>;</p>
</li>
<li>
<p><strong>spiAspspConsentDataProvider</strong>.</p>
</li>
<li>
<p><strong>authenticationMethodId</strong>: for a decoupled SCA method within embedded approach;</p>
</li>
<li>
<p><strong>authorisationId</strong>: a unique identifier of authorisation process.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_paymentcancellationspi">PaymentCancellationSpi</h4>
<div class="paragraph">
<p>The Interface is used to cancel a payment. The following Methods should be implemented:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>initiatePaymentCancellation</strong>;</p>
</li>
<li>
<p><strong>cancelPaymentWithoutSca</strong>;</p>
</li>
<li>
<p><strong>verifyScaAuthorisationAndCancelPayment</strong>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The Method <strong>initiatePaymentCancellation</strong> returns the payment cancellation response with information about transaction status and whether authorisation of the request is required. It contains the following data:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>spiContextData</strong>;</p>
</li>
<li>
<p><strong>payment</strong>: payment to be cancelled;</p>
</li>
<li>
<p><strong>spiAspspConsentDataProvider</strong>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The Method <strong>cancelPaymentWithoutSca</strong> is used by cancelling payment without performing SCA. Method returns a positive or negative payment cancellation response as part of spiResponse. It contains the following data:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>spiContextData</strong>;</p>
</li>
<li>
<p><strong>payment</strong>: payment to be cancelled;</p>
</li>
<li>
<p><strong>spiAspspConsentDataProvider</strong>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The Method <strong>verifyScaAuthorisationAndCancelPayment</strong> sends authorisation confirmation information (secure code or such) to ASPSP and, in case of successful validation, cancels payment at ASPSP.
It returns a positive or negative response as part of spiResponse. It contains the following data:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>spiContextData</strong>;</p>
</li>
<li>
<p><strong>payment</strong> payment to be cancelled;</p>
</li>
<li>
<p><strong>spiAspspConsentDataProvider</strong>.</p>
</li>
<li>
<p><strong>spiScaConfirmation</strong>: payment cancellation confirmation information.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_strong_customer_authentication_sca">Strong Customer Authentication (SCA)</h3>
<div class="paragraph">
<p>The Payment initiation depends heavily on the <strong>Strong Customer Authentication (SCA)</strong> approach implemented by the ASPSP. For now there are three Approaches implemented (REDIRECT, DECOUPLED and EMBEDDED).</p>
</div>
<div class="sect3">
<h4 id="_sca_approach_redirect">SCA Approach REDIRECT</h4>
<div class="paragraph">
<p>Prerequisites in case of <strong>consent for payment initiation</strong>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>PSU initiated a payment by using TPP;</p>
</li>
<li>
<p>PSU is authenticated via two factors: for example PSU ID and password;</p>
</li>
<li>
<p>Each Payment initiation needs its consent.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>When the Payment was initiated, it should be authorised by the PSU. In case of redirect approach the authorisation can be explicit or implicit.</p>
</div>
<div class="paragraph">
<p><strong>The explicit Start of the authorisation</strong> process means that Payment initiation Request is followed by an explicit Request of the TPP to start the authorisation. It is followed by a redirection to the ASPSP SCA authorisation site.
A status request might be requested by the TPP after the session is redirected to the TPP&#8217;s system. Redirect SCA Approach is used in case of <strong>tppExplicitAuthorisationPreferred = true</strong> and <strong>signingBasketSupported = true</strong> or in case of multilevel SCA.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>tppExplicitAuthorisationPreferred</strong>: value of TPP&#8217;s choice of authorisation method;</p>
</li>
<li>
<p><strong>signingBasketSupported</strong>: indicates if signing basket is supported on the ASPSP profile. It returns <em>true</em> if ASPSP supports signing basket, <em>false</em> if doesn&#8217;t.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In case of <strong>implicit Start of the Authorisation process</strong> the ASPSP needs no additional data from TPP. In this case, the redirection of the PSU browser session happens directly after the Payment Initiation Response.
Besides an SCA status request may be sent by the TPP to follow the SCA process. In this case, the authorisation is used based on <strong>tppExplicitAuthorisationPreferred</strong> and <strong>signingBasketSupported values</strong>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Implicit authorisation is used in all cases where <strong>tppExplicitAuthorisationPreferred</strong> or <strong>signingBasketSupported not equals true</strong>;</p>
</li>
<li>
<p>Implicit approach <strong>is impossible</strong> in case of multilevel SCA.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For The Redirect Approach the developer needs to implement the following Methods:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>createCommonPaymentAuthorisation</strong>;</p>
</li>
<li>
<p><strong>updateCommonPaymentPsuData</strong>;</p>
</li>
<li>
<p><strong>getAuthorisationSubResources</strong>;</p>
</li>
<li>
<p><strong>getAuthorisationScaStatus</strong>;</p>
</li>
<li>
<p><strong>getScaApproachServiceTypeProvider</strong>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The Method <strong>createCommonPaymentAuthorisation</strong> creates payment authorisation response and contains:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>paymentId</strong>: ASPSP identifier of a payment;</p>
</li>
<li>
<p><strong>paymentType</strong>: e.g. single payment, periodic payment, bulk payment;</p>
</li>
<li>
<p><strong>psuData</strong>: psuIdData container of authorisation data about PSU.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The Method <strong>updateCommonPaymentPsuData</strong> provides transporting data when updating consent psu data.
For the Redirect Approach this method is applicable for the selection of authentication methods, before choosing the actual SCA approach. It contains <strong>request</strong> with following data:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 1. Parameters</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Attribute</th>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">paymentId</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Resource identification of the related payment initiation</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">authorisationId</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Resource identification if the related payment initiation, Signing Basket or Consent authorisation sub-resource</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">scaAuthenticationData</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">SCA authentication data, depending on the chosen authentication method</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">psuData</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">e.g. PsuId, PsuIdType, PsuCorporateId and PsuCorporateIdType</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">password</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">PSU Data</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Password of the psu</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">authenticationMethodId</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The authentication method ID as provided by the ASPSP</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">scaStatus</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sca Status</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">e.g. psuIdentified</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">paymentService</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">e.g. "payments", "bulk-payments" and "periodic-payments"</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">paymentProduct</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The related payment product of the payment initiation to be authorized</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">updatePsuidentification</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">href Type</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The link to the payment initiation, which needs to be updated by the PSU identification if not delivered yet</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The Method <strong>getAuthorisationSubResources</strong> with the <strong>paymentId</strong> returns authorisation sub resources (e.g. list of authorisation IDs).</p>
</div>
<div class="paragraph">
<p>The Method <strong>getAuthorisationScaStatus</strong> with <strong>paymentId</strong> (ASPSP identifier of the payment, associated with the authorisation) and <strong>authorisationId</strong> (authorisation identifier), returns SCA status.</p>
</div>
<div class="paragraph">
<p><em>Example of Sca Status:</em></p>
</div>
<div class="ulist">
<ul>
<li>
<p>RECEIVED(“received”, false): if an authorisation or cancellation-authorisation resource has been created successfully.</p>
</li>
<li>
<p>PSUIDENTIFIED(“psuIdentified”, false): if the PSU related to the authorisation or cancellation-authorisation resource has been identified.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The Method <strong>getScaApproachServiceTypeProvider</strong> provides SCA approach used in current service. It returns the ScaApproach <strong>“Redirect”</strong>.</p>
</div>
<div class="sect4">
<h5 id="_redirect_approach_for_payment_cancellation">Redirect Approach for Payment cancellation</h5>
<div class="paragraph">
<p>The Method <strong>createCommonPaymentCancellationAuthorisation</strong> with <strong>paymentId</strong>, <strong>paymentType</strong> and <strong>psudata</strong> creates payment cancellation authorisation.</p>
</div>
<div class="paragraph">
<p>The Method  <strong>getCancellationAuthorisationSubResources</strong> with the <strong>paymentId</strong> returns authorisation sub resources.</p>
</div>
<div class="paragraph">
<p>The Method <strong>updateCommonPaymentCancellationPsuData</strong> updates the cancellation for the payment.</p>
</div>
<div class="paragraph">
<p>The Method <strong>getCancellationAuthorisationScaStatus</strong> with <strong>PaymentId</strong> and <strong>CancellationId</strong> (Resource identification of the related Payment Cancellation authorisation sub-resource) returns SCA status.</p>
</div>
<div class="paragraph">
<p>The Method <strong>getScaApproachServiceTypeProvider</strong> provides SCA approach used in current service. It returns the ScaApproach <strong>“Redirect”</strong>.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_sca_approach_embedded">SCA Approach EMBEDDED</h4>
<div class="paragraph">
<p>Embedded SCA approach indicates that the whole authorisation process is going to be performed through the XS2A interface, without any redirect to the online banking.
For this purposes, XS2A interface provides the following endpoints:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>PUT /v1/{payment-service}/{payment-product}/{paymentId}/authorisations/{authorisationId}</code> for payment initiation flow;</p>
</li>
<li>
<p><code>PUT /v1/{payment-service}/{payment-product}/{paymentId}/cancellation-authorisations/{cancellationId}</code> for payment cancellation flow;</p>
</li>
<li>
<p><code>PUT /v1/consents/{consentId}/authorisations/{authorisationId}</code> for consent initiation flow.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Embedded SCA Approach uses the same list of methods as Redirect SCA Approach:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>createCommonPaymentAuthorisation</strong>;</p>
</li>
<li>
<p><strong>updateCommonPaymentPsuData</strong>;</p>
</li>
<li>
<p><strong>getAuthorisationSubResources</strong>;</p>
</li>
<li>
<p><strong>getAuthorisationScaStatus</strong>;</p>
</li>
<li>
<p><strong>getScaApproachServiceTypeProvider</strong>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>After the successful authorisation start (either explicit or implicit), TPP should update the authorisation with data, provided by PSU.
Depending on the amount of SCA methods PSU has, the amount of PSU data, has to be provided, differs.
In case when PSU has zero SCA methods, only password should be provided.
In case when PSU has one SCA method, the password should be provided as well as authentication data (e.g. TAN received by email or SMS).
In case when PSU has more than one SCA method, PSU should first provide password, then select the preferred SCA method and then - the authentication data.
For each PSU data update, the same update endpoint should be called, but with corresponding body.</p>
</div>
<div class="paragraph">
<p>For example, PSU with two SCA methods initiates a payment.
Assume that the payment was created and the authorisation has started.
Now TPP should update PSU data three times:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>first <code>PUT /v1/{payment-service}/{payment-product}/{paymentId}/authorisations/{authorisationId}</code> call with PSU password in HTTP body</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>{
 	"psuData": {
 		"password": "mypassword"
 	}
}</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>second <code>PUT /v1/{payment-service}/{payment-product}/{paymentId}/authorisations/{authorisationId}</code> call with selected SCA method in HTTP body</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>{
    "authenticationMethodId": "selectedSCAMethod"
}</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>third <code>PUT /v1/{payment-service}/{payment-product}/{paymentId}/authorisations/{authorisationId}</code> call with authentication data in HTTP body</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>{
	"scaAuthenticationData": "TANNumber"
}</pre>
</div>
</div>
<div class="paragraph">
<p>After this steps, the payment initiation authorisation process will be finished.</p>
</div>
</div>
<div class="sect3">
<h4 id="_sca_approach_decoupled">SCA Approach DECOUPLED</h4>
<div class="paragraph">
<p>Decoupled SCA approach implies that authorsation will be performed with a help of dedicated mobile app, or any other application or device which is independent from the online banking frontend.
The workflow of Decoupled SCA approach is a short version of Embedded SCA approach.
After TPP updates PSU password via</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>PUT /v1/{payment-service}/{payment-product}/{paymentId}/authorisations/{authorisationId}</code>,</p>
</li>
<li>
<p><code>PUT /v1/{payment-service}/{payment-product}/{paymentId}/cancellation-authorisations/{cancellationId}</code> or</p>
</li>
<li>
<p><code>PUT /v1/consents/{consentId}/authorisations/{authorisationId}</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>endpoints, the response from ASPSP asks PSU to proceed authorisation in dedicated device.
No further authorisation calls from TPP are needed.
PSU uses the dedicated device and finishes authorisation process there.</p>
</div>
<div class="paragraph">
<p>Decoupled SCA Approach uses the same list of methods as Redirect SCA Approach:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>createCommonPaymentAuthorisation</strong>;</p>
</li>
<li>
<p><strong>updateCommonPaymentPsuData</strong>;</p>
</li>
<li>
<p><strong>getAuthorisationSubResources</strong>;</p>
</li>
<li>
<p><strong>getAuthorisationScaStatus</strong>;</p>
</li>
<li>
<p><strong>getScaApproachServiceTypeProvider</strong>.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_multicurrency_accounts">Multicurrency Accounts</h3>
<div class="paragraph">
<p>Multicurrency accounts support can be enabled in ASPSP Profile by setting <code>multicurrencyAccountLevelSupported</code> property to <code>AGGREGATION_AND_SUBACCOUNT</code> or <code>AGGREGATION</code> value.
By default, <code>multicurrencyAccountLevelSupported</code> property is set to <code>SUBACCOUNT</code>.
When TPP asks for account list information or account information (<strong>requestAccountList</strong> or <strong>requestAccountDetailForAccount</strong> method in AccountSpi), ASPSP can return <strong>null</strong> in currency field.
In such case, XS2A will mark <code>currency</code> field with <code>XXX</code> text.</p>
</div>
</div>
<div class="sect2">
<h3 id="_get_spi_sca_status">Get SPI SCA status</h3>
<div class="paragraph">
<p>ASPSP should have a possibility to update authorisation status from bank&#8217;s internal system related to consent/payment confirmation due to the fact that not every system is capable of updating the status in CMS.
For this reason AuthorisationSpi has method <code>getScaStatus</code> which calls ASPSP for actual status. The CMS SCA status will be updated if it is not final and differs from the bank.
By default, SCA status is used from CMS on request for getting SCA status.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_configuring_xs2a_service">Configuring XS2A Service</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="configuring-logging">Configuring Logging</h3>
<div class="paragraph">
<p>XS2A uses <strong>SLF4J</strong> for logging and provides named loggers <strong>access-log</strong> and <strong>request-log</strong>, as well as per class loggers(with logger name set to corresponding fully-qualified name of the class).
Both <strong>access-log</strong> and <strong>request-log</strong> are operating at <strong>INFO</strong> logging level only.</p>
</div>
<div class="paragraph">
<p>XS2A provides default configuration file <strong>logback-spring.xml</strong> for configuring logs with <strong>Logback</strong> and <strong>Spring</strong>.
This configuration redirects messages from <strong>access-log</strong> and <strong>request-log</strong> loggers to the console and logs other messages on <strong>DEBUG</strong> level to both console and file.
If the change of logging configuration is needed, custom logback file (<strong>logback.xml</strong> or <strong>logback.groovy</strong> if Groovy is on the classpath) should be created in the root of the classpath with appropriate configurations.</p>
</div>
<div class="paragraph">
<p>Although XS2A provides configuration file for <strong>Logback</strong>, it&#8217;s possible to configure and use any logging framework that&#8217;s compatible with <strong>SLF4J</strong>.</p>
</div>
</div>
<div class="sect2">
<h3 id="propagating-request-information">Propagating information about the request from XS2A to external services</h3>
<div class="paragraph">
<p>By default XS2A propagates information about the TPP request (in form of internal request ID and X-Request-ID) to CMS and ASPSP Profile services.
This is done by providing additional headers with relevant information about the request for each REST call to CMS or ASPSP Profile, initiated by the XS2A service.</p>
</div>
<div class="paragraph">
<p>If there&#8217;s a need to propagate this information to other services, it&#8217;s possible to make use of classes from <code>xs2a-logger-web</code> module.
<code>de.adorsys.psd2.logger.web.LoggingContextInterceptor</code> is responsible for intercepting REST calls to external services and populating request headers with information about the request.
This interceptor should be applied to all requests to the external service.
In order to make use of the provided information, external service should provide implementation of <code>de.adorsys.psd2.logger.web.AbstractLoggingContextFilter</code> for extracting data from request headers and storing them in the logging context.</p>
</div>
</div>
<div class="sect2">
<h3 id="configuring-payment-validation-rules">Configuring payment validation rules</h3>
<div class="paragraph">
<p>XS2A provides an opportunity to change the validation rules for payment body during payment initiation request by providing custom country-specific rules.</p>
</div>
<div class="paragraph">
<p>To configure custom validation rules, new implementation of <code>de.adorsys.psd2.validator.payment.CountryValidatorHolder</code> interface should be provided as a Spring bean in the application with appropriate country identifier.
During the payment initiation request XS2A will try to find and execute implementation of <code>CountryValidatorHolder</code> with country identifier matching to the value of <code>countryValidationSupported</code> property in the ASPSP profile.
If there is no custom implementation for the country identifier specified in ASPSP profile, XS2A will use validation rules for Germany by default.</p>
</div>
</div>
<div class="sect2">
<h3 id="configuring-mapping-type-specific-payments-spi">Configuring mapping of type-specific payments for SPI</h3>
<div class="paragraph">
<p>In general XS2A handles all payments as common payments, regardless of payment type and payment product.
This means that the request body of any payment will be stored in CMS and transferred to SPI in form of byte array just as it was received from TPP, without any transformation or mapping by XS2A.
All payment-related SPI calls will be forwarded to <code>de.adorsys.psd2.xs2a.spi.service.CommonPaymentSpi</code> implementation.</p>
</div>
<div class="paragraph">
<p>This is the preferred approach and to enable it connector application should provide dependency on <code>xs2a-payment-common-impl</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>&lt;dependency&gt;
    &lt;groupId&gt;de.adorsys.psd2&lt;/groupId&gt;
    &lt;artifactId&gt;xs2a-payment-common-impl&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>To provide backward compatibility with previous versions it&#8217;s possible to use support library that will provide payments with standard payment products to SPI as parsed payments.
In this case standard payments will be mapped into type-specific implementations of <code>de.adorsys.psd2.xs2a.spi.service.SpiPayment</code> (<code>SpiSinglePayment</code>, <code>SpiPeriodicPayment</code> and <code>SpiBulkPayment</code>) before being passed to SPI level.
All payment-related SPI calls will be forwarded to appropriate implementations of <code>de.adorsys.psd2.xs2a.spi.service.PaymentSpi</code> (<code>SinglePaymentSpi</code>, <code>PeriodicPaymentSpi</code>, <code>BulkPaymentSpi</code>).
Only non-standard payments will be handled as common payments and forwarded to <code>de.adorsys.psd2.xs2a.spi.service.CommonPaymentSpi</code>.</p>
</div>
<div class="paragraph">
<p>To enable this mapping, connector application should use <code>xs2a-payment-support-impl</code> module instead of <code>xs2a-payment-common-impl</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>&lt;dependency&gt;
    &lt;groupId&gt;de.adorsys.psd2&lt;/groupId&gt;
    &lt;artifactId&gt;xs2a-payment-support-impl&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>See <a href="#configuring-mapping-type-specific-payments-cms-apis">Configuring mapping of type-specific payments for CMS APIs</a> for providing similar configuration for CMS application.</p>
</div>
</div>
<div class="sect2">
<h3 id="_configuring_xs2a_filters">Configuring XS2A filters</h3>
<div class="paragraph">
<p>XS2A relies on specific order of filter execution to function correctly and relies on connector application to maintain that order.</p>
</div>
<div class="paragraph">
<p>If connector is launched as Spring Boot application, the order will be guaranteed by the priority of the filter beans and no additional configuration is required.
If it&#8217;s not the case, connector should make sure that <code>de.adorsys.psd2.xs2a.web.filter.Xs2aLoggingContextFilter</code> will be executed first,
then <code>de.adorsys.psd2.xs2a.web.filter.ContentCachingWrappingFilter</code> and then any other XS2A filter.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_configuring_cms_service">Configuring CMS Service</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="configuring-mapping-type-specific-payments-cms-apis">Configuring mapping of type-specific payments for CMS APIs</h3>
<div class="paragraph">
<p>In general XS2A handles all payments as common payments, regardless of payment type and payment product.
This means that the request body of any payment will be stored in CMS and presented in response of <code>cms-aspsp-api</code> and <code>cms-psu-api</code> methods and endpoints as byte array.</p>
</div>
<div class="paragraph">
<p>This is the preferred approach and to enable it CMS application should provide dependency on <code>cms-payment-common-impl</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>&lt;dependency&gt;
    &lt;groupId&gt;de.adorsys.psd2&lt;/groupId&gt;
    &lt;artifactId&gt;cms-payment-common-impl&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>To provide backward compatibility with previous versions it&#8217;s possible to use support library that will transform payments with standard payment products into type-specific implementations of <code>de.adorsys.psd2.consent.api.pis.CmsBasePaymentResponse</code> (<code>CmsSinglePayment</code>, <code>CmsPeriodicPayment</code> and <code>CmsBulkPayment</code>).
To enable such transformation, CMS application should use <code>cms-payment-support-impl</code> module instead of <code>cms-payment-common-impl</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>&lt;dependency&gt;
    &lt;groupId&gt;de.adorsys.psd2&lt;/groupId&gt;
    &lt;artifactId&gt;cms-payment-support-impl&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>See <a href="#configuring-mapping-type-specific-payments-spi">Configuring mapping of type-specific payments for SPI</a> for providing similar configuration for XS2A application.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_working_with_cms">Working with CMS</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_using_the_cms_psu_api">Using the CMS-PSU-API</h3>
<div class="paragraph">
<p>CMS PSU API provides interfaces to be used by online-banking systems. Main purpose of these interfaces - providing
access to internal data of business objects stored in CMS database. Access to this API is provided via REST requests.
REST controllers classes are located in the <code>de.adorsys.psd2.consent.web.psu.controller</code> package.</p>
</div>
<div class="paragraph">
<p>CMS-PSU-API has 4 main parts which are implemented as separate REST controllers:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>ASPSP consent data part;</p>
</li>
<li>
<p>AIS consent part;</p>
</li>
<li>
<p>PIS payment part;</p>
</li>
<li>
<p>PIIS consent part.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Below is the description of each controller with its endpoints and names of corresponding java source code methods.</p>
</div>
<div class="sect3">
<h4 id="_aspsp_consent_data_controller">ASPSP consent data controller</h4>
<div class="paragraph">
<p>This controller has endpoints for handling ASPSP consent data.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>GET /psu-api/v1/aspsp-consent-data/consents/{consent-id}</strong> - reads ASPSP consent data by provided consent/payment ID. Corresponding java method - <code>getAspspConsentData</code>;</p>
</li>
<li>
<p><strong>PUT /psu-api/v1/aspsp-consent-data/consents/{consent-id}</strong> - updates ASPSP consent data by provided consent/payment ID. Java method - <code>updateAspspConsentData</code>;</p>
</li>
<li>
<p><strong>DELETE /psu-api/v1/aspsp-consent-data/consents/{consent-id}</strong> - clears ASPSP consent data by provided consent/payment ID. Method - <code>deleteAspspConsentData</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>More detailed ASPSP data handling is described
<a href="./Implementing SPI-API.html">here</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_ais_consent_controller">AIS consent controller</h4>
<div class="paragraph">
<p>This controller has endpoints for working with AIS consent entities and their attributes.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>GET /psu-api/v1/ais/consent/{consent-id}</strong> - returns AIS consent object by provided ID (ID should be internal). Corresponding java method is <code>getConsentByConsentId</code>;</p>
</li>
<li>
<p><strong>PUT /psu-api/v1/ais/consent/{consent-id}/authorisation/{authorisation-id}/psu-data</strong> - updates PSU data for definite consent. Java - <code>updatePsuDataInConsent</code>;</p>
</li>
<li>
<p><strong>PUT /psu-api/v1/ais/consent/{consent-id}/authorisation/{authorisation-id}/status/{status}</strong> - updates status of AIS consent authorisation. Java - <code>updateAuthorisationStatus</code>;</p>
</li>
<li>
<p><strong>GET /psu-api/v1/ais/consent/{consent-id}/authorisation/psus</strong> - returns map consisting of PSU data IDs (keys) and statuses of their authorisations for the given consent (values). Method - <code>psuDataAuthorisations</code>;</p>
</li>
<li>
<p><strong>PUT /psu-api/v1/ais/consent/{consent-id}/confirm-consent</strong> - switches the AIS consent status to <code>VALID</code>. Method name - <code>confirmConsent</code>;</p>
</li>
<li>
<p><strong>PUT /psu-api/v1/ais/consent/{consent-id}/reject-consent</strong> - switches the AIS consent status to <code>REJECTED</code>. Method - <code>rejectConsent</code>;</p>
</li>
<li>
<p><strong>PUT /psu-api/v1/ais/consent/{consent-id}/revoke-consent</strong> - switches the AIS consent status to <code>REVOKED_BY_PSU</code>. Method - <code>revokeConsent</code>;</p>
</li>
<li>
<p><strong>PUT /psu-api/v1/ais/consent/{consent-id}/authorise-partially-consent</strong> - switches the AIS consent status to <code>PARTIALLY_AUTHORISED</code>. Method - <code>authorisePartiallyConsent</code>;</p>
</li>
<li>
<p><strong>PUT /psu-api/v1/ais/consent/{consent-id}/save-access</strong> - stores the account accesses for the definite consent with proper status (not applicable to <code>REVOKED</code>, <code>CANCELLED</code> and <code>EXPIRED</code> consent statuses). To be used for bank offered consents only. Java method - <code>putAccountAccessInConsent</code>;</p>
</li>
<li>
<p><strong>GET /psu-api/v1/ais/consent/authorisation/{authorisation-id}</strong> - returns authorisation object by its ID. Method - <code>getAuthorisationByAuthorisationId</code>;</p>
</li>
<li>
<p><strong>GET /psu-api/v1/ais/consent/consents</strong> - returns list of AIS consents by provided <code>PSU-ID</code> header. Java method - <code>getConsentsForPsu</code>;</p>
</li>
<li>
<p><strong>GET /psu-api/v1/ais/consent/redirect/{redirect-id}</strong> - returns AIS consent object by provided authorisation (redirect) ID. Method - <code>getConsentIdByRedirectId</code>.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_pis_payment_controller">PIS payment controller</h4>
<div class="paragraph">
<p>This controller has endpoints for working with PIS payment entities and their attributes.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>GET /psu-api/v1/payment/{payment-id}</strong> - returns PIS payment object by provided ID (ID should be internal). Corresponding java method is <code>getPaymentByPaymentId</code>;</p>
</li>
<li>
<p><strong>PUT /psu-api/v1/payment/{payment-id}/authorisation/{authorisation-id}/status/{status}</strong> - updates status of PIS payment authorisation. Java method - <code>updateAuthorisationStatus</code>;</p>
</li>
<li>
<p><strong>GET /psu-api/v1/payment/{payment-id}/authorisation/psus</strong> - returns map consisting of PSU data IDs (keys) and statuses of their authorisations for the given payment (values). Also, holds the type of authorisation for payment (<code>CREATED</code>/<code>CANCELLED</code>). Method for this - <code>psuAuthorisationStatuses</code>;</p>
</li>
<li>
<p><strong>PUT /psu-api/v1/payment/{payment-id}/status/{status}</strong> - switches the PIS payment status. The status should be provided as a path variable. Method - <code>updatePaymentStatus</code>;</p>
</li>
<li>
<p><strong>GET /psu-api/v1/payment/authorisation/{authorisation-id}</strong> - returns authorisation object by its ID; Method - <code>getAuthorisationByAuthorisationId</code>;</p>
</li>
<li>
<p><strong>PUT /psu-api/v1/payment/authorisation/{authorisation-id}/psu-data</strong> - updates PSU data for definite authorisation. Method - <code>updatePsuInPayment</code>;</p>
</li>
<li>
<p><strong>GET /psu-api/v1/payment/cancellation/{payment-id}</strong> - returns PIS payment object by provided cancellation ID. Used method - <code>getPaymentByPaymentIdForCancellation</code>;</p>
</li>
<li>
<p><strong>GET /psu-api/v1/payment/cancellation/redirect/{redirect-id}</strong> - returns PIS payment object by provided cancellation authorisation (redirect) ID. Method - <code>getPaymentIdByRedirectIdForCancellation</code>;</p>
</li>
<li>
<p><strong>GET /psu-api/v1/payment/redirect/{redirect-id}</strong> - returns PIS payment object by provided authorisation (redirect) ID. Method - <code>getPaymentIdByRedirectId</code>.</p>
</li>
<li>
<p><strong>PUT psu-api/v1/payment/{payment_service}/{payment_product}/{payment_id}</strong> - updates initial payment.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_piis_consent_controller">PIIS consent controller</h4>
<div class="paragraph">
<p>This controller has endpoints for working with PIIS consent entities and their attributes.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>GET /psu-api/v1/piis/consents</strong> - returns list of PIIS consent objects by provided header <code>PSU-ID</code>. Method name - <code>getConsentsForPsu</code>;</p>
</li>
<li>
<p><strong>GET /psu-api/v1/piis/consents/{consent-id}</strong> - returns PIIS consent object by its ID. Method - <code>getConsent</code>;</p>
</li>
<li>
<p><strong>PUT /psu-api/v1/piis/consents/{consent-id}/revoke-consent</strong> - revokes the definite PIIS consent (status switches to <code>REVOKED_BY_PSU</code>). In java - <code>revokeConsent</code>.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_using_the_cms_aspsp_api">Using the CMS-ASPSP-API</h3>
<div class="paragraph">
<p><code>CMS-ASPSP-API</code> is an API for banks to make particular changes in <code>CMS</code> and to get needed information from it.
In order to do it, you can use several <code>CMS-ASPSP-API</code> REST controllers. They are located in the
<code>de.adorsys.psd2.consent.web.aspsp.controller</code> package.</p>
</div>
<div class="paragraph">
<p><code>CMS-ASPSP-API</code> includes next interfaces:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Events interface;</p>
</li>
<li>
<p>FundsConfirmation Consent interface;</p>
</li>
<li>
<p>Consents/Payments export interface;</p>
</li>
<li>
<p>Payment Transaction interface;</p>
</li>
<li>
<p>Tpp locking interface;</p>
</li>
<li>
<p>Tpp info interface.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><code>CMS-ASPSP-API</code> REST controllers provide next endpoints:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>GET aspsp-api/v1/events</code> - get events for dates.</p>
</li>
<li>
<p><code>POST aspsp-api/v1/piis/consents</code> - create PIIS consent.</p>
</li>
<li>
<p><code>GET aspsp-api/v1/piis/consents</code> - get PIIS consents for PSU.</p>
</li>
<li>
<p><code>DELETE aspsp-api/v1/piis/consents/{consent-id}</code> - terminate PIIS consent.</p>
</li>
<li>
<p><code>GET aspsp-api/v1/ais/consents/tpp/{tpp-id}</code> - get consents by TPP.</p>
</li>
<li>
<p><code>GET aspsp-api/v1/ais/consents/psu</code> - get consents by PSU.</p>
</li>
<li>
<p><code>GET aspsp-api/v1/ais/consents/account/{account-id}</code> - get consents by account.</p>
</li>
<li>
<p><code>GET aspsp-api/v1/pis/payments/tpp/{tpp-id}</code> - get payments by TPP.</p>
</li>
<li>
<p><code>GET aspsp-api/v1/pis/payments/psu</code> - get payments by PSU.</p>
</li>
<li>
<p><code>GET aspsp-api/v1/pis/payments/account/{account-id}</code> - get payments by account ID.</p>
</li>
<li>
<p><code>GET aspsp-api/v1/piis/consents/tpp/{tpp-id}</code> - get PIIS consents by TPP.</p>
</li>
<li>
<p><code>GET aspsp-api/v1/piis/consents/psu</code> - get PIIS consents by PSU.</p>
</li>
<li>
<p><code>GET aspsp-api/v1/piis/consents/account/{account-id}</code> - get PIIS consents by account ID.</p>
</li>
<li>
<p><code>PUT aspsp-api/v1/pis/transaction-status/{payment-id}/status/{status}</code> - update payment status.</p>
</li>
<li>
<p><code>GET aspsp-api/v1/tpp/stop-list</code> - get TPP stop list record.</p>
</li>
<li>
<p><code>PUT aspsp-api/v1/tpp/stop-list/block</code> - block TPP.</p>
</li>
<li>
<p><code>DELETE aspsp-api/v1/tpp/stop-list/unblock</code> - unblock TPP.</p>
</li>
<li>
<p><code>GET aspsp-api/v1/tpp/</code> - get TPP info.</p>
</li>
<li>
<p><code>GET aspsp-api/v1/tpp/{tpp-id}</code> - get TPP info with path.</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_using_the_events_interface">Using the Events interface</h4>

</div>
<div class="sect3">
<h4 id="_using_the_funds_confirmation_consent_interface">Using the Funds Confirmation Consent interface</h4>
<div class="paragraph">
<p>Funds Confirmation Consent interface (PIIS consent interface) allows ASPSP to manage consents for accessing Confirmation of Funds Service.
It should be used only if ASPSP supports PIIS consents created by the ASPSP.
This interface can be accessed either by REST endpoints in CMS or by Java methods in <code>de.adorsys.psd2.consent.aspsp.api.piis.CmsAspspPiisService</code> (in case of using CMS in embedded mode).</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>POST aspsp-api/v1/piis/consents</code> (or <code>CmsAspspPiisService#createConsent</code>) - creates new PIIS consent for given PSU.
Request for creating new consent must contain PSU credentials data, TPP authorisation number, account reference information and <code>validUntil</code> date.
If the consent was successfully created, its ID will be returned in the response.
Because PSU can only have one PIIS consent for one account and TPP, previously existing PIIS consent for the same PSU, account and TPP will get revoked (its status will become <code>revokedByPsu</code>)</p>
</li>
<li>
<p><code>GET aspsp-api/v1/piis/consents</code> (or <code>CmsAspspPiisService#getConsentsForPsu</code>) - returns list of all PIIS consents, associated with given PSU and optional instance ID.</p>
</li>
<li>
<p><code>DELETE aspsp-api/v1/piis/consents/{consent-id}</code> (or <code>CmsAspspPiisService#terminateConsent</code>) - terminates PIIS consent by its ID and optional instance ID.
Consent will get status <code>terminatedByAspsp</code>.
Response will contain <code>true</code> if the consent was found and successfully terminated, <code>false</code> otherwise.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_using_the_consentspayments_export_interface">Using the Consents/Payments export interface</h4>
<div class="paragraph">
<p>Consents/Payments export interfaces give an opportunity to get consent/payment by <code>TPP</code>, <code>PSU</code> or <code>account ID</code>.
In order to do that, you need to request endpoints of one of the <code>CMS-ASPSP-API</code> REST controllers:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>CmsAspspAisExportController</code> - provides access to ais consents;</p>
</li>
<li>
<p><code>CmsAspspPisExportController</code> - provides access to payments;</p>
</li>
<li>
<p><code>CmsAspspPiisExportController</code> - provides access to piis consents.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><code>CmsAspspAisExportController</code> export endpoints are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>GET aspsp-api/v1/ais/consents/tpp/{tpp-id}</code> - get <code>consents</code> by <code>TPP</code>. Requesting this endpoint you&#8217;ll get a list of
<code>AIS consents</code> objects by given mandatory <code>TPP ID</code>, optional <code>creation date</code>, <code>PSU ID Data</code> and <code>instance ID</code>.
Corresponding java method - <code>getConsentsByTpp</code>;</p>
</li>
<li>
<p><code>GET aspsp-api/v1/ais/consents/psu</code> - get <code>consents</code> by <code>PSU</code>. Requesting this endpoint you&#8217;ll get a list of
<code>AIS consents</code> objects by given mandatory <code>PSU ID Data</code>, optional <code>creation date</code> and <code>instance ID</code>.
Corresponding java method - <code>getConsentsByPsu</code>.</p>
</li>
<li>
<p><code>GET aspsp-api/v1/ais/consents/account/{account-id}</code> - get <code>consents</code> by <code>account ID</code>. Requesting this endpoint
you&#8217;ll get a list of <code>AIS consents</code> objects by given mandatory <code>aspsp account id</code>, optional <code>creation date</code>
and <code>instance ID</code>. Corresponding java method - <code>getConsentsByAccount</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><code>CmsAspspPisExportController</code> export endpoints are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>GET aspsp-api/v1/pis/payments/tpp/{tpp-id}</code> - get <code>payments</code> by <code>TPP</code>. Requesting this endpoint you&#8217;ll get a list of
<code>payments</code> objects by given mandatory <code>TPP ID</code>, optional <code>creation date</code>, <code>PSU ID Data</code> and <code>instance ID</code>.
Corresponding java method - <code>getPaymentsByTpp</code>.</p>
</li>
<li>
<p><code>GET aspsp-api/v1/pis/payments/psu</code> - get <code>payments</code> by <code>PSU</code>. Requesting this endpoint you&#8217;ll get a list of
<code>payments</code> objects by given mandatory <code>PSU ID Data</code>, optional <code>creation date</code> and <code>instance ID</code>.
Corresponding java method - <code>getPaymentsByPsu</code>.</p>
</li>
<li>
<p><code>GET aspsp-api/v1/pis/payments/account/{account-id}</code> - get <code>payments</code> by <code>account ID</code>. Requesting this endpoint you&#8217;ll
get a list of <code>payments</code> objects by given mandatory <code>aspsp account id</code>, optional <code>creation date</code> and <code>instance ID</code>.
Corresponding java method - <code>getPaymentsByAccountId</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><code>CmsAspspPiisExportController</code> export endpoints are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>GET aspsp-api/v1/piis/consents/tpp/{tpp-id}</code> - get <code>PIIS consents</code> by <code>TPP</code>. Requesting this endpoint you&#8217;ll
get a list of <code>PIIS consents</code> by given mandatory <code>TPP ID</code>, optional <code>creation date</code>, <code>PSU ID Data</code> and <code>instance ID</code>.
Corresponding java method - <code>getConsentsByTpp</code>.</p>
</li>
<li>
<p><code>GET aspsp-api/v1/piis/consents/psu</code> - get <code>PIIS consents</code> by <code>PSU</code>. Requesting this endpoint you&#8217;ll
get a list of <code>PIIS consents</code> by given mandatory <code>PSU ID Data</code>, optional <code>creation date</code> and <code>instance ID</code>.
Corresponding java method - <code>getConsentsByPsu</code>.</p>
</li>
<li>
<p><code>GET aspsp-api/v1/piis/consents/account/{account-id}</code> - get <code>PIIS consents</code> by <code>account ID</code>. Requesting this endpoint
you&#8217;ll get a list of <code>PIIS consents</code> by given mandatory <code>aspsp account id</code>, optional <code>creation date</code> and <code>instance ID</code>.
Corresponding java method - <code>getConsentsByAccountId</code>.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_using_the_payment_transaction_interface">Using the Payment Transaction interface</h4>
<div class="paragraph">
<p>Payment transaction interface serves for changing transaction status for payment in CMS database.
In consists one REST controller -  <code>CmsAspspPisTransactionController</code>.</p>
</div>
<div class="paragraph">
<p><code>CmsAspspPisTransactionController</code> has one endpoint:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>PUT /aspsp-api/v1/pis/transaction-status/{payment-id}/status/{status}</code> - update <code>transaction status</code>.
On this endpoint you can update <code>transaction status</code> of <code>payment</code> by its <code>payment ID</code>.
In order to do this you should enter <code>payment id</code> and new <code>transaction status</code> as path variables,
also you can pass <code>instance id</code> as header, but it is not required.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_using_the_tpp_locking_interface">Using the Tpp locking interface</h4>
<div class="paragraph">
<p>Tpp locking interface gives an access to <code>TPP stop list</code> and provides possibility to block and unblock <code>TPP</code> by
<code>TPP authorisation number</code>. In order to do it, you can use <code>Tpp locking</code> REST controller - <code>CmsAspspStopListController</code>.</p>
</div>
<div class="paragraph">
<p><code>CmsAspspStopListController</code> endpoints are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>GET aspsp-api/v1/tpp/stop-list</code> - get <code>TPP stop list</code> record. Requesting this endpoint you&#8217;ll get <code>TPP stop list
record</code> by mandatory <code>TPP authorisation number</code> and optional <code>instance ID</code>.
Corresponding java method - <code>getTppStopListRecord</code>.</p>
</li>
<li>
<p><code>PUT aspsp-api/v1/tpp/stop-list/block</code> - block <code>TPP</code>. Requesting this endpoint you&#8217;ll block <code>TPP</code> by mandatory
<code>TPP authorisation number</code>, optional <code>instance ID</code> and <code>lock period</code>. Corresponding java method - <code>blockTpp</code>.</p>
</li>
<li>
<p><code>DELETE aspsp-api/v1/tpp/stop-list/unblock</code> - unblock <code>TPP</code>. Requesting this endpoint you&#8217;ll unblock <code>TPP</code> by
mandatory <code>TPP authorisation number</code> and optional <code>instance ID</code>. Corresponding java method - <code>unblockTpp</code>.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_using_the_tpp_info_interface">Using the Tpp info interface</h4>
<div class="paragraph">
<p>Tpp info interface provide access to <code>TPP info</code>. In order to get it, you can use <code>Tpp info</code> REST controller -
<code>CmsAspspTppInfoController</code>.</p>
</div>
<div class="paragraph">
<p><code>CmsAspspTppInfoController</code> endpoints are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>GET aspsp-api/v1/tpp/</code> - get <code>TPP info</code>. Requesting this endpoint you&#8217;ll get <code>TPP</code> info by mandatory
<code>TPP authorisation number</code> and optional <code>instance ID</code>. Corresponding java method - <code>getTppInfo</code>.</p>
</li>
<li>
<p><code>GET aspsp-api/v1/tpp/{tpp-id}</code> - get TPP info with path. Requesting this endpoint you&#8217;ll get <code>TPP info</code> with path
by mandatory <code>TPP ID</code>, <code>TPP authorisation number</code> and optional <code>instance ID</code>. Corresponding java method -
<code>getTppInfoWithPath</code>.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_upgrading_xs2a_instances_version_on_the_same_server">Upgrading XS2A instances version on the same server</h2>
<div class="sectionbody">
<div class="paragraph">
<p>There is a possibility to launch several instances of embedded XS2A on the same server using common datasource. We provide
backward compatibility for 2 versions to have a possibility to upgrade version of each XS2A step by step.
Below are the steps which are required to change version of XS2A instances with common database. It is a good point to have a separate test environment with the current backend version with the test database before changing the production environment.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Create the database backup.</p>
</li>
<li>
<p>Create the liquibase.properties file in <code>/consent-management/cms-db-schema/</code> with your DB configuration,
for example:  </p>
<div class="literalblock">
<div class="content">
<pre>url=jdbc:postgresql://localhost/consent?currentSchema=consent
username=cms
password=cms
changeLogFile=src/main/resources/master.xml</pre>
</div>
</div>
</li>
<li>
<p>Create the SQL upgrade script from the liquibase scripts of the new desired version by launching commands:</p>
<div class="literalblock">
<div class="content">
<pre>cd consent-management/cms-db-schema/
mvn liquibase:updateSQL</pre>
</div>
</div>
</li>
<li>
<p>Apply the SQL script to the DB.</p>
</li>
<li>
<p>Ensure that SQL script was applied without any errors and DB has all previous data untouched.</p>
</li>
<li>
<p>Stop the first XS2A instance.</p>
</li>
<li>
<p>Change the image of first XS2A instance.</p>
</li>
<li>
<p>Switch off the automatic liquibase migration in the first XS2A instance by setting the configuration parameter: <code>spring.liquibase.enabled=false</code>. This parameter is stored in the application.yml. This step is required to avoid automatic DB updating.</p>
</li>
<li>
<p>Launch the first instance of XS2A.</p>
</li>
<li>
<p>Repeat 6-9 for rest XS2A instances.</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_special_modes">Special modes</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_multi_tenancy_support">Multi-tenancy support</h3>
<div class="paragraph">
<p>By default, multi-tenancy mode is disabled.
Multi-tenancy is an architecture in which a single instance of a software application serves multiple customers.
Each customer shares the software applications (ASPSP Profile, CMS) and shares a single database. Each tenant’s data is isolated and remains invisible to other tenants.</p>
</div>
<div class="paragraph">
<p>ASPSP Profile supports multi-tenancy mode. Configuration can be done by switching flag on and registering all supporting bank profiles in <code>application.yml</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>xs2a.bank_profile.multitenancy.enabled=true
xs2a.bank_profile.multitenancy.customBankProfiles={bank1:'classpath:bank1_profile.yml', bank2:'classpath:bank2_profile.yml'}</code></pre>
</div>
</div>
<div class="paragraph">
<p>When multi-tenancy is enabled and fully configured additional header <code>instance-id</code> is required for all HTTP requests, otherwise get an error 400 <code>BAD_REQUEST</code>.</p>
</div>
<div class="paragraph">
<p>It&#8217;s possible to use CMS database in multi-tenancy mode, with multiple XS2A instances being connected to one CMS database.
This approach is not recommended and in general multiple XS2A instances should be used with their own database instances.
But if it&#8217;s still necessary to use one database, CMS should be additionally configured to support this mode.</p>
</div>
<div class="paragraph">
<p>Each record in the database that should be isolated from different XS2A instances contains <code>instance_id</code> column, which indicates particular XS2A instance that created this resource.
To access such resource, appropriate <code>instanceId</code> value should be passed to methods and endpoints in <code>cms-psu-api</code> and <code>cms-aspsp-api</code>.
Default value for <code>instanceId</code> is set to <code>UNDEFINED</code>.</p>
</div>
<div class="paragraph">
<p>To configure CMS service to properly work with multiple XS2A instances, multiple instances of <code>cms-standalone-service</code> can be used, with <code>xs2a.cms.service.instance-id</code> property set to appropriate value for each instance.
Alternatively, some kind of an interceptor should be implemented in CMS (or in connector application in case of using CMS in embedded mode) to set <code>instanceId</code> property before saving records to the database.
Example of Hibernate interceptor with such functionality can be found in <code>cms-standalone-service</code>: in <code>de.adorsys.psd2.consent.config.ServiceInstanceIdEventListener</code>, along with the configuration in <code>de.adorsys.psd2.consent.config.HibernateListenerConfig</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_support_multi_tenancy_in_xs2a">Support multi-tenancy in XS2A</h3>
<div class="paragraph">
<p>XS2A supports multi-tenancy with 1 database and 1 CMS instances.
Request header <code>Instance-ID</code> defines a current tenant. The header is not mandatory.</p>
</div>
<div class="paragraph">
<p>Response link <code>scaRedirect</code> will include <code>Instance-ID</code> parameter if the mentioned header comes with request.</p>
</div>
<div class="paragraph">
<p>SPI objects <code>SpiAccountConsent</code>, <code>SpiPaymentInfo</code>, <code>SpiSinglePayment</code> and <code>SpiBulkPayment</code> were extended for <code>instanceId</code> field.</p>
</div>
</div>
<div class="sect2">
<h3 id="_support_multi_tenancy_in_aspsp_profile">Support multi-tenancy in ASPSP Profile</h3>
<div class="paragraph">
<p>ASPSP Profile supports more than one ASPSP profiles. In this mode ASPSP Profile needs to be configured for each supporting instances separately.
HTTP header <code>instance-id</code> is required for all requests to the profile otherwise error will occur.</p>
</div>
<div class="paragraph">
<p>To enable multi tenancy in ASPSP Profile in <code>application.yml</code> set flag and register config profiles for every tenant:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>xs2a.bank_profile.multitenancy.enabled=true
xs2a.bank_profile.multitenancy.customBankProfiles={bank1:'classpath:bank1_profile.yml', bank2:'classpath:bank2_profile.yml'}</code></pre>
</div>
</div>
<div class="paragraph">
<p>By default, multi-tenancy mode for ASPSP Profile is disabled.</p>
</div>
</div>
<div class="sect2">
<h3 id="_configure_event_service_in_embedded_mode">Configure Event-Service in embedded mode</h3>
<div class="paragraph">
<p>XS2A is started as a standalone application in embedded mode (<strong>Xs2aStandaloneStarter</strong>).
CMS does not start at all.</p>
</div>
<div class="paragraph">
<p><strong>Xs2aStandaloneStarter</strong> application has database configuration, event service and CMS parts inside.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Update <strong>application.properties</strong> of <strong>xs2a-standalone-starter</strong> by adding database configuration:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>spring.datasource.url=jdbc:postgresql://localhost/consent
spring.datasource.username=cms
spring.datasource.password=cms</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Remove maven dependencies in <strong>xs2a-standalone-starter</strong> pom.xml:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre> &lt;dependency&gt;
     &lt;groupId&gt;de.adorsys.psd2&lt;/groupId&gt;
     &lt;artifactId&gt;consent-xs2a-client&lt;/artifactId&gt;
     &lt;version&gt;${project.version}&lt;/version&gt;
 &lt;/dependency&gt;

&lt;dependency&gt;
     &lt;groupId&gt;de.adorsys.psd2&lt;/groupId&gt;
     &lt;artifactId&gt;event-service-rest-client&lt;/artifactId&gt;
     &lt;version&gt;${project.version}&lt;/version&gt;
 &lt;/dependency&gt;</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Add maven dependencies in <strong>xs2a-standalone-starter</strong> pom.xml:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre> &lt;dependency&gt;
     &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
     &lt;artifactId&gt;spring-boot-starter-data-jpa&lt;/artifactId&gt;
 &lt;/dependency&gt;

&lt;dependency&gt;
     &lt;groupId&gt;de.adorsys.psd2&lt;/groupId&gt;
     &lt;artifactId&gt;event-service-xs2a-impl&lt;/artifactId&gt;
     &lt;version&gt;${project.version}&lt;/version&gt;
 &lt;/dependency&gt;

&lt;dependency&gt;
     &lt;groupId&gt;de.adorsys.psd2&lt;/groupId&gt;
     &lt;artifactId&gt;event-service-aspsp-impl&lt;/artifactId&gt;
     &lt;version&gt;${project.version}&lt;/version&gt;
 &lt;/dependency&gt;

&lt;dependency&gt;
     &lt;groupId&gt;de.adorsys.psd2&lt;/groupId&gt;
     &lt;artifactId&gt;event-service-persist-db-impl&lt;/artifactId&gt;
     &lt;version&gt;${project.version}&lt;/version&gt;
 &lt;/dependency&gt;

&lt;dependency&gt;
     &lt;groupId&gt;de.adorsys.psd2&lt;/groupId&gt;
     &lt;artifactId&gt;consent-management-lib&lt;/artifactId&gt;
     &lt;version&gt;${project.version}&lt;/version&gt;
 &lt;/dependency&gt;

&lt;dependency&gt;
     &lt;groupId&gt;de.adorsys.psd2&lt;/groupId&gt;
     &lt;artifactId&gt;consent-aspsp-web&lt;/artifactId&gt;
     &lt;version&gt;${project.version}&lt;/version&gt;
 &lt;/dependency&gt;

 &lt;dependency&gt;
      &lt;groupId&gt;de.adorsys.psd2&lt;/groupId&gt;
      &lt;artifactId&gt;cms-scheduler-service&lt;/artifactId&gt;
      &lt;version&gt;${project.version}&lt;/version&gt;
 &lt;/dependency&gt;</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Update scan annotations in <strong>Xs2aStandaloneStarter.java</strong>:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>   @ComponentScan(basePackages = "de.adorsys.psd2")
   @EnableTransactionManagement
   @EnableJpaRepositories(basePackages = {"de.adorsys.psd2.consent.repository", "de.adorsys.psd2.event"})
   @EntityScan({"de.adorsys.psd2.consent.domain", "de.adorsys.psd2.event.persist.entity"})</pre>
</div>
</div>
<div class="sect3">
<h4 id="_getting_events">Getting events</h4>
<div class="paragraph">
<p>There are 5 endpoints for getting events:</p>
</div>
<div class="paragraph">
<p><code>GET aspsp-api/v1/events</code></p>
</div>
<div class="paragraph">
<p><code>GET aspsp-api/v1/events/consent/{consent-id}</code></p>
</div>
<div class="paragraph">
<p><code>GET aspsp-api/v1/events/payment/{payment-id}</code></p>
</div>
<div class="paragraph">
<p><code>GET aspsp-api/v1/events/type/{event-type}</code></p>
</div>
<div class="paragraph">
<p><code>GET aspsp-api/v1/events/origin/{event-origin}</code></p>
</div>
<div class="paragraph">
<p>Request parameters for the all 5 endpoints above are passed as headers:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 2. Request Headers</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Header</th>
<th class="tableblock halign-left valign-top">Required</th>
<th class="tableblock halign-left valign-top">Default value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">start-date</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">true</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">end-date</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">true</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">instance-id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">UNDEFINED</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Description:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>GET aspsp-api/v1/events</code> &#8201;&#8212;&#8201; Use endpoint for getting events <strong>by period</strong>
and <strong>instance_id</strong>.</p>
</li>
<li>
<p><code>GET aspsp-api/v1/events/consent/{consent-id}</code> &#8201;&#8212;&#8201; Use endpoint for getting events <strong>by period</strong>
and <strong>instance_id</strong> with specific consent
identifier <strong>consent_id</strong>.</p>
</li>
</ul>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 3. <strong>consent_id</strong> path variable usage.</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Path variable</th>
<th class="tableblock halign-left valign-top">Required</th>
<th class="tableblock halign-left valign-top">Example</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">consent-id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">true</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">bf489af6-a2cb-4b75-b71d-d66d58b934d7</p></td>
</tr>
</tbody>
</table>
<div class="ulist">
<ul>
<li>
<p><code>GET aspsp-api/v1/events/payment/{payment-id}</code> &#8201;&#8212;&#8201; Use endpoint for getting events <strong>by period</strong>
and <strong>instance_id</strong> with a specific
identifier of created payment <strong>payment_id</strong>.</p>
</li>
</ul>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 4. <strong>payment_id</strong> path variable usage.</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Path variable</th>
<th class="tableblock halign-left valign-top">Required</th>
<th class="tableblock halign-left valign-top">Example</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">payment-id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">true</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">bf489af6-a2cb-4b75-b71d-d66d58b934d7</p></td>
</tr>
</tbody>
</table>
<div class="ulist">
<ul>
<li>
<p><code>GET aspsp-api/v1/events/type/{event-type}</code> &#8201;&#8212;&#8201; Use endpoint for getting events <strong>by period</strong>
and <strong>instance_id</strong> with a specific type of event <strong>event_type</strong>.</p>
</li>
</ul>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 5. <strong>event_type</strong> path variable usage.</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Path variable</th>
<th class="tableblock halign-left valign-top">Required</th>
<th class="tableblock halign-left valign-top">Example</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">event-type</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">true</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">CREATE_SIGNING_BASKET_REQUEST_RECEIVED</p></td>
</tr>
</tbody>
</table>
<div class="ulist">
<ul>
<li>
<p><code>GET aspsp-api/v1/events/origin/{event-origin}</code> &#8201;&#8212;&#8201; Use endpoint for getting events
<strong>by period</strong> and <strong>instance_id</strong> for a specific origin type of event <strong>event_origin</strong>.</p>
</li>
</ul>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 6. <strong>event_origin</strong> path variable usage.</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Path variable</th>
<th class="tableblock halign-left valign-top">Required</th>
<th class="tableblock halign-left valign-top">Example</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">event-origin</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">true</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ASPSP</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="_configuring_events_recording">Configuring events recording</h4>
<div class="paragraph">
<p>Recording of events can be tweaked by using custom implementations of interfaces from <strong>event-service-persist-api</strong>.
Two implementations of these interfaces are provided by default in separate modules:
- implementation for saving events to the database, can be enabled by adding dependency to the <strong>event-service-persist-db-impl</strong>
- implementation for logging events, can be enabled by adding dependency to the <strong>event-service-persist-log-impl</strong></p>
</div>
<div class="paragraph">
<p>These modules don&#8217;t provide implementation of <strong>de.adorsys.psd2.event.persist.EventReportRepository</strong> for generating event reports.
This means that either default implementation for reading events from the database should be added as a dependency (<strong>event-service-db-report-impl</strong>), endpoints for retrieving events report from the <strong>cms-aspsp-api</strong> should be disabled, or custom implementation of the interface should be provided.</p>
</div>
<div class="paragraph">
<p>Logging implementation uses <strong>SLF4J</strong> for recording events, meaning that it&#8217;s possible to configure and use any logging framework that&#8217;s compatible with <strong>SLF4J</strong>.
All events are being written to a separate logger <strong>event-log</strong> at <strong>INFO</strong> level.
See <a href="#configuring-logging">XS2A Logging configuring</a> for more details on how to configure <strong>SLF4J</strong> logging.</p>
</div>
</div>
<div class="sect3">
<h4 id="_adjusting_swagger_ui">Adjusting swagger UI</h4>
<div class="paragraph">
<p>Swagger UI is not enabled for XS2A by default.</p>
</div>
<div class="paragraph">
<p>To enable Swagger in XS2A you have to add <code>@EnableXs2aSwagger</code> annotation on any of Spring configuration classes / Spring boot Application class in your application.</p>
</div>
<div class="paragraph">
<p>To disable Swagger just remove it.</p>
</div>
<div class="paragraph">
<p>Adjustment Swagger UI implies updating appropriate .yaml file:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>At first put PSD2 API yaml file to the resource folder of your Connector to override default PSD2 API and set <code>xs2a.swagger.psd2.api.location</code> property in your application.properties file e.g. <code>xs2a.swagger.psd.api.location=path/in/my/classpath/my_swagger_api.yml</code></p>
</li>
<li>
<p>Next steps involve adding and changing necessary parameters in the .yaml file.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The default version of PSD2 API yaml file can be found under:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>xs2a-impl-&gt;src-&gt;main-&gt;resources-&gt;static-&gt;psd2-api....yaml</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
for adding additional products e.g., it should be updated ASPSP-Profile as well.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_certificate_generator">Certificate generator</h2>
<div class="sectionbody">
<hr>
<div class="paragraph">
<p>How to use certificate generator</p>
</div>
<div class="paragraph">
<p>1) Build project</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>cd ./certificate-generator
mvn clean install</code></pre>
</div>
</div>
<div class="paragraph">
<p>2) Launch the application</p>
</div>
<div class="paragraph">
<p>3) Open <code>swagger-ui.html</code>, fill in certificate data and execute the request.
Mocked certificate in xs2a-impl uses the data provided as example in Swagger UI for the request with the following changes: commonName attribute contains empty value and roles attribute contains PISP, AISP and PIISP roles.</p>
</div>
<div class="paragraph">
<p>4) Response will contain certificate and its private key</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_configuration_properties">Configuration properties</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_supported_configuration_properties">Supported configuration properties</h3>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Property</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Default value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">xs2a.license.url</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Link to license agreement</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://github.com/adorsys/xs2a/blob/master/LICENSE.md" class="bare">https://github.com/adorsys/xs2a/blob/master/LICENSE.md</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">xs2a.rest-consent-config.read-timeout.ms</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Read timeout for consent REST API in ms</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">10000</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">xs2a.rest-consent-config.connection-timeout.ms</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Connection timeout for consent REST API in ms</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1000</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">xs2a.masked-pan-begin-chars</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Masked PAN begin chars for identification</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">6</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">xs2a.masked-pan-end-chars</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Masked PAN end chars for identification</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">xs2a.cms.consent-service.baseurl</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Consent service base URL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://localhost:38080/api/v1" class="bare">http://localhost:38080/api/v1</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">xs2a.cms.aspsp-profile.baseurl</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ASPSP service base URL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="http://localhost:48080/api/v1" class="bare">http://localhost:48080/api/v1</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">xs2a.cms.service.instance-id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Instance identification</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">UNDEFINED</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">xs2a.cms.stoplist.cron.expression</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Cron expression to unblock TPP in stop list</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0 0 * * * *</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">xs2a.cms.not-confirmed-consent-expiration.cron.expression</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Cron expression to update status for non confirmed consents</p>
<p class="tableblock">RECOMMENDED: run at least with 15 min delay with <code>xs2a.cms.used-non-recurring-consent-expiration.cron.expression</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0 0 * * * *</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">xs2a.cms.not-confirmed-payment-expiration.cron.expression</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Cron expression to update status for non confirmed payments</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0 0 * * * *</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">xs2a.cms.used-non-recurring-consent-expiration.cron.expression</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Cron expression to expire non-recurring consents</p>
<p class="tableblock">RECOMMENDED: run at least with 15 min delay with <code>xs2a.cms.not-confirmed-consent-expiration.cron.expression</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0 15 * * * *</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">xs2a.cms.consent.cron.expression</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Cron expression to expire consents with statuses (VALID and RECEIVED)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0 0 1 * * ?</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">xs2a.cms.scheduler.pool.size</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Size of CMS scheduler pool</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">30</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">xs2a.cms.scheduler.processing.page-size</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Size of processed page</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">100</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">xs2a.cms.encryption.defaultProvider.dataProvider</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Crypto provider for Data encryption</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">JcHZwvJMuc</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">xs2a.cms.encryption.defaultProvider.idProvider</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Crypto provider for ID encryption</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">psGLvQpt9Q</p></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_multilevel_sca">Multilevel Sca</h2>
<div class="sectionbody">
<div class="paragraph">
<p>On initiation payment request (*PaymentSpi.initiatePayment(&#8230;&#8203;)) or create consent request (AisConsentSpi.initiateAisConsent(&#8230;&#8203;)) in SPI level
ASPSP is able to provide <code>multilevelScaRequired</code> flag.
When this flag is true, then XS2A doesn&#8217;t start creation of authorisation implicitly for consent or payment. In this case XS2A provides to TPP additional
link <code>startAuthorisation</code> for starting authorisation process for several PSUs.
Then different PSUs, that are involved in payment or consent authorisation process, are able to create authorisation using this link.</p>
</div>
<div class="paragraph">
<p>When the authorisation from first PSU is finalised and second PSU is in progress, ASPSP is able to change status of payment or consent, to indicate that status is partially authorised.</p>
</div>
<div class="paragraph">
<p>For payment status should be <strong>TransactionStatus.PATC</strong>, for consent <strong>ConsentStatus.PARTIALLY_AUTHORISED</strong>.</p>
</div>
<div class="paragraph">
<p>In EMBEDDED approach this could be done in next SPI methods:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>for payment in <code>PaymentSpi.executePaymentWithoutSca(&#8230;&#8203;)</code> or <code>verifyScaAuthorisationAndExecutePaymentWithPaymentResponse(&#8230;&#8203;)</code></p>
</li>
<li>
<p>for consent in <code>AisConsentSpi.verifyScaAuthorisation(&#8230;&#8203;)</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In Redirect approach this could be done using CMS-PSU-API:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>for payment use <code>CmsPsuPisService.updatePaymentStatus(&#8230;&#8203;)</code> or <code>PUT /psu-api/v1/payment/{payment-id}/status/{status}</code> endpoint</p>
</li>
<li>
<p>for consent use <code>CmsPsuAisService.authorisePartiallyConsent(&#8230;&#8203;)</code> method or <code>PUT /psu-api/v1/ais/consent/{consent-id}/authorise-partially-consent</code> endpoint</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_extending_payment_validation">Extending payment validation</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In order to extend payment validation with custom bank&#8217;s requirements, one needs to override:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>DefaultPaymentValidationConfigImpl</code> with custom <code>ValidationObject</code> fields (Occurrence and max length);</p>
</li>
<li>
<p><code>DefaultPaymentBodyFieldsValidatorImpl</code> with overridden method <code>createPaymentValidationConfig</code> (put there custom DefaultPaymentValidationConfigImpl extension);</p>
</li>
<li>
<p><code>DefaultPaymentValidatorHolder</code> with passing custom extended <code>DefaultPaymentBodyFieldsValidatorImpl</code> in constructor parameters and overridden method <code>isCustom</code> (return true here);</p>
</li>
<li>
<p><code>CustomPaymentValidationService</code> with annotation <code>@Primary</code> and override needed methods according to bank&#8217;s requirements. Use
<code>ErrorBuildingService</code> to enrich message error.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2022-02-15 12:45:56 UTC
</div>
</div>
</body>
</html>